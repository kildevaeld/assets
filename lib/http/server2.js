"use strict";

var __awaiter = undefined && undefined.__awaiter || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) {
            try {
                step(generator.next(value));
            } catch (e) {
                reject(e);
            }
        }
        function rejected(value) {
            try {
                step(generator.throw(value));
            } catch (e) {
                reject(e);
            }
        }
        function step(result) {
            result.done ? resolve(result.value) : new P(function (resolve) {
                resolve(result.value);
            }).then(fulfilled, rejected);
        }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
var Koa = require('koa');
var Router = require('koa-router');
var Path = require('path');
var URL = require('url');
var convert = require('koa-convert'),
    cors = require('koa-cors'),
    body = require('koa-body');
function toBoolean(str) {
    return !! ~['true', 'TRUE', 't', 'y', 'j', 'yes'].indexOf(str);
}
function App(client) {
    var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    var app = new Koa();
    var router = new Router();
    var p = options.prefix || '/';
    router.post(p, convert(body({ multipart: true })), createAsset);
    router.get(p, listAssets);
    router.get(Path.join(p, '*'), getAsset);
    router.del(Path.join(p, '*'), deleteAsset);
    app.use(convert(cors({
        origin: '*',
        expose: ['Link']
    })));
    app.use(router.routes());
    //app.use(router.allowedMethods())
    //router.put('/')
    return app;
    function listAssets(ctx) {
        return __awaiter(this, void 0, void 0, function* () {
            ctx.type = 'json';
            var query = ctx.query;
            if (query.id) {
                var asset = yield client.getById(query.id);
                if (!asset) {
                    ctx.throw(404, { message: 'not found' });
                }
                ctx.body = asset;
            }
            var page = 1,
                limit = 100;
            if (query.page) {
                var i = parseInt(query.page);
                if (!isNaN(i)) page = i;
            }
            if (query.limit) {
                var _i = parseInt(query.limit);
                if (!isNaN(_i)) limit = _i;
            }
            if (page <= 0) page = 1;
            var result = void 0;
            if (query.q) {
                result = yield client.query(query.q);
            } else {
                var count = yield client.metaStore.count();
                var pages = Math.ceil(count / limit);
                var offset = limit * (page - 1);
                if (offset > count) {
                    result = [];
                } else {
                    result = yield client.list({
                        offset: offset,
                        limit: limit
                    });
                }
                var links = {
                    first: 1,
                    last: pages
                };
                if (page > 1) links.prev = page - 1;
                if (page < pages) links.next = page + 1;
                _writeLinksHeader(ctx, links);
            }
            ctx.body = result;
        });
    }
    function getAsset(ctx) {
        return __awaiter(this, void 0, void 0, function* () {
            var query = ctx.query;
            var path = ctx.path;
            if (path[0] !== '/') path = "/" + path;
            var asset = yield client.getByPath(path);
            console.log(asset);
            if (!asset) ctx.throw(404);
            if (toBoolean(query.meta)) {
                ctx.body = asset;
                return;
            }
            ctx.type = asset.mime;
            //res.setHeader('Content-Type', asset.mime);
            //res.setHeader('Content-Length', asset.size + "");
            if (toBoolean(query.download)) {
                ctx.set('Content-Disposition', 'attachment; filename=' + asset.filename);
            }
            var outStream = void 0;
            if (toBoolean(query.thumbnail)) {
                ctx.set('Content-Type', 'image/png');
                outStream = yield client.thumbnail(asset);
                console.log(outStream);
                if (outStream == null) {
                    ctx.throw(400, {
                        message: 'Cannot generate thumbnail for mimetype: ' + asset.mime
                    });
                }
            } else {
                outStream = yield client.stream(asset);
            }
            ctx.status = 200;
            ctx.body = outStream;
        });
    }
    function createAsset(ctx) {
        return __awaiter(this, void 0, void 0, function* () {
            /*let contentType = ctx.get('content-type')
            if (!contentType || contentType.indexOf('multipart/form-data') == -1) {
                //throw new Error('not multiform');
                let query = ctx.query
                     if (query.filename) {
                         let len = parseInt(ctx.get('content-length')),
                        type : string = contentType;
                        
                         let path = query.path||'/'
                    if (path[path.length - 1] != '/') path += '/';
                    let asset = await this._assets.create(req, path + query.filename, {
                        mime: type,
                        size: len,
                        skipMeta: false
                    });
                         ctx.type = 'json';
                    ctx.body = asset;
                     }
                throw new Error('not multiform');
            }
                 let {files, fields} = await this._readForm(req);
                 let file: formidable.File;
            for (let k in files) {
                file = files[k];
                break;
            }
                 if (!file) throw new Error('not file');
                      let path = fields['path']|| '/',
                dest = Path.join(path, file.name),
                opts: AssetCreateOptions = {skipMeta:false};
                 if (fields['name'] && fields['name'] != "") {
                opts.name = fields['name'];
            }
                 if (fields['mime'] && fields['mime'] != "") {
                opts.mime = fields['mime'];
            }
            debug('create file "%s", options "%j"', dest, opts);
            let asset = await this._assets.createFromPath(file.path, dest, opts);
                 await this._writeJSON(res, asset, 201);*/
            var contentType = ctx.req.headers['content-type'];
            if (!contentType || contentType.indexOf('multipart/form-data') == -1) {
                //throw new Error('not multiform');
                var query = ctx.query;
                if (query.filename) {
                    var len = parseInt(ctx.get('content-length')),
                        type = contentType;
                    var _path = query.path || '/';
                    if (_path[_path.length - 1] != '/') _path += '/';
                    var _asset = yield client.create(ctx.req, _path + query.filename, {
                        mime: type,
                        size: len,
                        skipMeta: false
                    });
                    ctx.type = 'json';
                    ctx.body = _asset;
                    return;
                }
                ctx.throw(400, 'No name spcified');
            }
            ctx.type = "json";
            var body = ctx.request.body;
            var file = body.files.file;
            if (file == null) {
                ctx.throw(403);
            }
            var fields = body.fields;
            var path = body.fields.path || '/',
                dest = Path.join(path, file.name),
                opts = { skipMeta: false };
            if (fields.name && fields.name != "") {
                opts.name = fields.name;
            }
            if (fields.mime && fields.mime != "") {
                opts.mime = fields.mime;
            }
            var asset = yield client.createFromPath(file.path, dest, opts);
            ctx.status = 201;
            ctx.body = asset;
        });
    }
    function updateAsset(ctx) {}
    function deleteAsset(ctx) {}
    function _writeLinksHeader(ctx, links) {
        var url = ctx.url;
        url = ctx.get('host') + url; // +  (url.indexOf('?') == -1 ? "?" : "&") + 'page=';
        url = "http://" + url;
        var u = URL.parse(url, true);
        if (u.query) {
            /*let query = Qs.parse(u.query);*/
            if (u.query.page) {
                delete u.query.page;
            }
            //u.query = Qs.stringify(query);
            u.search = null;
            url = URL.format(u);
            url += "&page=";
        } else {
            url += '?page=';
        }
        ctx.set('Link', Object.keys(links).map(function (rel) {
            return '<' + url + links[rel] + '>; rel="' + rel + '"';
        }).join(', '));
    }
}
exports.App = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHAvc2VydmVyMi5qcyIsImh0dHAvc2VydmVyMi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJLFlBQVksU0FBQyxJQUFRLFVBQUssU0FBTCxJQUFtQixVQUFVLE9BQVYsRUFBbUIsVUFBbkIsRUFBK0IsQ0FBL0IsRUFBa0MsU0FBbEMsRUFBNkM7QUFDckYsV0FBTyxLQUFLLE1BQU0sSUFBSSxPQUFKLENBQU4sQ0FBTCxDQUF5QixVQUFVLE9BQVYsRUFBbUIsTUFBbkIsRUFBMkI7QUFDdkQsaUJBQVMsU0FBVCxDQUFtQixLQUFuQixFQUEwQjtBQUFFLGdCQUFJO0FBQUUscUJBQUssVUFBVSxJQUFWLENBQWUsS0FBZixDQUFMLEVBQUY7YUFBSixDQUFxQyxPQUFPLENBQVAsRUFBVTtBQUFFLHVCQUFPLENBQVAsRUFBRjthQUFWO1NBQWpFO0FBQ0EsaUJBQVMsUUFBVCxDQUFrQixLQUFsQixFQUF5QjtBQUFFLGdCQUFJO0FBQUUscUJBQUssVUFBVSxLQUFWLENBQWdCLEtBQWhCLENBQUwsRUFBRjthQUFKLENBQXNDLE9BQU8sQ0FBUCxFQUFVO0FBQUUsdUJBQU8sQ0FBUCxFQUFGO2FBQVY7U0FBakU7QUFDQSxpQkFBUyxJQUFULENBQWMsTUFBZCxFQUFzQjtBQUFFLG1CQUFPLElBQVAsR0FBYyxRQUFRLE9BQU8sS0FBUCxDQUF0QixHQUFzQyxJQUFJLENBQUosQ0FBTSxVQUFVLE9BQVYsRUFBbUI7QUFBRSx3QkFBUSxPQUFPLEtBQVAsQ0FBUixDQUFGO2FBQW5CLENBQU4sQ0FBcUQsSUFBckQsQ0FBMEQsU0FBMUQsRUFBcUUsUUFBckUsQ0FBdEMsQ0FBRjtTQUF0QjtBQUNBLGFBQUssQ0FBQyxZQUFZLFVBQVUsS0FBVixDQUFnQixPQUFoQixFQUF5QixVQUF6QixDQUFaLENBQUQsQ0FBbUQsSUFBbkQsRUFBTCxFQUp1RDtLQUEzQixDQUFoQyxDQURxRjtDQUE3QztBQ0M1QyxJQUFZLE1BQUcsUUFBTSxLQUFOLENBQUg7QUFD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UztBQVNULG1CQUFPLFFBQVAsQ0FUUztTQUFiLE1BV087QUFDSCxtQkFBTyxRQUFQLENBREc7U0FYUDtBQWVBLFlBQUksR0FBSixDQUFRLE1BQVIsRUFBZ0IsT0FBTyxJQUFQLENBQVksS0FBWixFQUFtQixHQUFuQixDQUF1QixVQUFTLEdBQVQsRUFBWTtBQUMvQyxtQkFBTyxNQUFNLEdBQU4sR0FBWSxNQUFNLEdBQU4sQ0FBWixHQUF5QixVQUF6QixHQUFzQyxHQUF0QyxHQUE0QyxHQUE1QyxDQUR3QztTQUFaLENBQXZCLENBRWIsSUFGYSxDQUVSLElBRlEsQ0FBaEIsRUF4QnNHO0tBQTdHO0NBalFEO0FBQWdCLFFBQUEsR0FBQSxHQUFHLEdBQUgiLCJmaWxlIjoiaHR0cC9zZXJ2ZXIyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci50aHJvdyh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5jb25zdCBLb2EgPSByZXF1aXJlKCdrb2EnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IFBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBVUkwgPSByZXF1aXJlKCd1cmwnKTtcbmNvbnN0IGNvbnZlcnQgPSByZXF1aXJlKCdrb2EtY29udmVydCcpLCBjb3JzID0gcmVxdWlyZSgna29hLWNvcnMnKSwgYm9keSA9IHJlcXVpcmUoJ2tvYS1ib2R5Jyk7XG5mdW5jdGlvbiB0b0Jvb2xlYW4oc3RyKSB7XG4gICAgcmV0dXJuICEhflsndHJ1ZScsICdUUlVFJywgJ3QnLCAneScsICdqJywgJ3llcyddLmluZGV4T2Yoc3RyKTtcbn1cbmZ1bmN0aW9uIEFwcChjbGllbnQsIG9wdGlvbnMgPSB7fSkge1xuICAgIGxldCBhcHAgPSBuZXcgS29hKCk7XG4gICAgbGV0IHJvdXRlciA9IG5ldyBSb3V0ZXIoKTtcbiAgICBsZXQgcCA9IG9wdGlvbnMucHJlZml4IHx8ICcvJztcbiAgICByb3V0ZXIucG9zdChwLCBjb252ZXJ0KGJvZHkoeyBtdWx0aXBhcnQ6IHRydWUgfSkpLCBjcmVhdGVBc3NldCk7XG4gICAgcm91dGVyLmdldChwLCBsaXN0QXNzZXRzKTtcbiAgICByb3V0ZXIuZ2V0KFBhdGguam9pbihwLCAnKicpLCBnZXRBc3NldCk7XG4gICAgcm91dGVyLmRlbChQYXRoLmpvaW4ocCwgJyonKSwgZGVsZXRlQXNzZXQpO1xuICAgIGFwcC51c2UoY29udmVydChjb3JzKHtcbiAgICAgICAgb3JpZ2luOiAnKicsXG4gICAgICAgIGV4cG9zZTogWydMaW5rJ11cbiAgICB9KSkpO1xuICAgIGFwcC51c2Uocm91dGVyLnJvdXRlcygpKTtcbiAgICAvL2FwcC51c2Uocm91dGVyLmFsbG93ZWRNZXRob2RzKCkpXG4gICAgLy9yb3V0ZXIucHV0KCcvJylcbiAgICByZXR1cm4gYXBwO1xuICAgIGZ1bmN0aW9uIGxpc3RBc3NldHMoY3R4KSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjdHgudHlwZSA9ICdqc29uJztcbiAgICAgICAgICAgIGxldCBxdWVyeSA9IGN0eC5xdWVyeTtcbiAgICAgICAgICAgIGlmIChxdWVyeS5pZCkge1xuICAgICAgICAgICAgICAgIGxldCBhc3NldCA9IHlpZWxkIGNsaWVudC5nZXRCeUlkKHF1ZXJ5LmlkKTtcbiAgICAgICAgICAgICAgICBpZiAoIWFzc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyg0MDQsIHsgbWVzc2FnZTogJ25vdCBmb3VuZCcgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGN0eC5ib2R5ID0gYXNzZXQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgcGFnZSA9IDEsIGxpbWl0ID0gMTAwO1xuICAgICAgICAgICAgaWYgKHF1ZXJ5LnBhZ2UpIHtcbiAgICAgICAgICAgICAgICBsZXQgaSA9IHBhcnNlSW50KHF1ZXJ5LnBhZ2UpO1xuICAgICAgICAgICAgICAgIGlmICghaXNOYU4oaSkpXG4gICAgICAgICAgICAgICAgICAgIHBhZ2UgPSBpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHF1ZXJ5LmxpbWl0KSB7XG4gICAgICAgICAgICAgICAgbGV0IGkgPSBwYXJzZUludChxdWVyeS5saW1pdCk7XG4gICAgICAgICAgICAgICAgaWYgKCFpc05hTihpKSlcbiAgICAgICAgICAgICAgICAgICAgbGltaXQgPSBpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBhZ2UgPD0gMClcbiAgICAgICAgICAgICAgICBwYWdlID0gMTtcbiAgICAgICAgICAgIGxldCByZXN1bHQ7XG4gICAgICAgICAgICBpZiAocXVlcnkucSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IHlpZWxkIGNsaWVudC5xdWVyeShxdWVyeS5xKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGxldCBjb3VudCA9IHlpZWxkIGNsaWVudC5tZXRhU3RvcmUuY291bnQoKTtcbiAgICAgICAgICAgICAgICBsZXQgcGFnZXMgPSBNYXRoLmNlaWwoY291bnQgLyBsaW1pdCk7XG4gICAgICAgICAgICAgICAgbGV0IG9mZnNldCA9IGxpbWl0ICogKHBhZ2UgLSAxKTtcbiAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ID4gY291bnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gW107XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB5aWVsZCBjbGllbnQubGlzdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG9mZnNldCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbWl0OiBsaW1pdFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IGxpbmtzID0ge1xuICAgICAgICAgICAgICAgICAgICBmaXJzdDogMSxcbiAgICAgICAgICAgICAgICAgICAgbGFzdDogcGFnZXNcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGlmIChwYWdlID4gMSlcbiAgICAgICAgICAgICAgICAgICAgbGlua3MucHJldiA9IHBhZ2UgLSAxO1xuICAgICAgICAgICAgICAgIGlmIChwYWdlIDwgcGFnZXMpXG4gICAgICAgICAgICAgICAgICAgIGxpbmtzLm5leHQgPSBwYWdlICsgMTtcbiAgICAgICAgICAgICAgICBfd3JpdGVMaW5rc0hlYWRlcihjdHgsIGxpbmtzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGN0eC5ib2R5ID0gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZ2V0QXNzZXQoY3R4KSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBsZXQgcXVlcnkgPSBjdHgucXVlcnk7XG4gICAgICAgICAgICBsZXQgcGF0aCA9IGN0eC5wYXRoO1xuICAgICAgICAgICAgaWYgKHBhdGhbMF0gIT09ICcvJylcbiAgICAgICAgICAgICAgICBwYXRoID0gXCIvXCIgKyBwYXRoO1xuICAgICAgICAgICAgbGV0IGFzc2V0ID0gKHlpZWxkIGNsaWVudC5nZXRCeVBhdGgocGF0aCkpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYXNzZXQpO1xuICAgICAgICAgICAgaWYgKCFhc3NldClcbiAgICAgICAgICAgICAgICBjdHgudGhyb3coNDA0KTtcbiAgICAgICAgICAgIGlmICh0b0Jvb2xlYW4ocXVlcnkubWV0YSkpIHtcbiAgICAgICAgICAgICAgICBjdHguYm9keSA9IGFzc2V0O1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGN0eC50eXBlID0gYXNzZXQubWltZTtcbiAgICAgICAgICAgIC8vcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgYXNzZXQubWltZSk7XG4gICAgICAgICAgICAvL3Jlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtTGVuZ3RoJywgYXNzZXQuc2l6ZSArIFwiXCIpO1xuICAgICAgICAgICAgaWYgKHRvQm9vbGVhbihxdWVyeS5kb3dubG9hZCkpIHtcbiAgICAgICAgICAgICAgICBjdHguc2V0KCdDb250ZW50LURpc3Bvc2l0aW9uJywgJ2F0dGFjaG1lbnQ7IGZpbGVuYW1lPScgKyBhc3NldC5maWxlbmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgb3V0U3RyZWFtO1xuICAgICAgICAgICAgaWYgKHRvQm9vbGVhbihxdWVyeS50aHVtYm5haWwpKSB7XG4gICAgICAgICAgICAgICAgY3R4LnNldCgnQ29udGVudC1UeXBlJywgJ2ltYWdlL3BuZycpO1xuICAgICAgICAgICAgICAgIG91dFN0cmVhbSA9IHlpZWxkIGNsaWVudC50aHVtYm5haWwoYXNzZXQpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG91dFN0cmVhbSk7XG4gICAgICAgICAgICAgICAgaWYgKG91dFN0cmVhbSA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyg0MDAsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdDYW5ub3QgZ2VuZXJhdGUgdGh1bWJuYWlsIGZvciBtaW1ldHlwZTogJyArIGFzc2V0Lm1pbWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgb3V0U3RyZWFtID0geWllbGQgY2xpZW50LnN0cmVhbShhc3NldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjdHguc3RhdHVzID0gMjAwO1xuICAgICAgICAgICAgY3R4LmJvZHkgPSBvdXRTdHJlYW07XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBmdW5jdGlvbiBjcmVhdGVBc3NldChjdHgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIC8qbGV0IGNvbnRlbnRUeXBlID0gY3R4LmdldCgnY29udGVudC10eXBlJylcbiAgICAgICAgICAgIGlmICghY29udGVudFR5cGUgfHwgY29udGVudFR5cGUuaW5kZXhPZignbXVsdGlwYXJ0L2Zvcm0tZGF0YScpID09IC0xKSB7XG4gICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoJ25vdCBtdWx0aWZvcm0nKTtcbiAgICAgICAgICAgICAgICBsZXQgcXVlcnkgPSBjdHgucXVlcnlcbiAgICBcbiAgICAgICAgICAgICAgICBpZiAocXVlcnkuZmlsZW5hbWUpIHtcbiAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IGxlbiA9IHBhcnNlSW50KGN0eC5nZXQoJ2NvbnRlbnQtbGVuZ3RoJykpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA6IHN0cmluZyA9IGNvbnRlbnRUeXBlO1xuICAgIFxuICAgICAgICAgICAgICAgICAgIFxuICAgIFxuICAgICAgICAgICAgICAgICAgICBsZXQgcGF0aCA9IHF1ZXJ5LnBhdGh8fCcvJ1xuICAgICAgICAgICAgICAgICAgICBpZiAocGF0aFtwYXRoLmxlbmd0aCAtIDFdICE9ICcvJykgcGF0aCArPSAnLyc7XG4gICAgICAgICAgICAgICAgICAgIGxldCBhc3NldCA9IGF3YWl0IHRoaXMuX2Fzc2V0cy5jcmVhdGUocmVxLCBwYXRoICsgcXVlcnkuZmlsZW5hbWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pbWU6IHR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzaXplOiBsZW4sXG4gICAgICAgICAgICAgICAgICAgICAgICBza2lwTWV0YTogZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgXG4gICAgICAgICAgICAgICAgICAgIGN0eC50eXBlID0gJ2pzb24nO1xuICAgICAgICAgICAgICAgICAgICBjdHguYm9keSA9IGFzc2V0O1xuICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBtdWx0aWZvcm0nKTtcbiAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgIGxldCB7ZmlsZXMsIGZpZWxkc30gPSBhd2FpdCB0aGlzLl9yZWFkRm9ybShyZXEpO1xuICAgIFxuICAgICAgICAgICAgbGV0IGZpbGU6IGZvcm1pZGFibGUuRmlsZTtcbiAgICAgICAgICAgIGZvciAobGV0IGsgaW4gZmlsZXMpIHtcbiAgICAgICAgICAgICAgICBmaWxlID0gZmlsZXNba107XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICBpZiAoIWZpbGUpIHRocm93IG5ldyBFcnJvcignbm90IGZpbGUnKTtcbiAgICBcbiAgICBcbiAgICAgICAgICAgIGxldCBwYXRoID0gZmllbGRzWydwYXRoJ118fCAnLycsXG4gICAgICAgICAgICAgICAgZGVzdCA9IFBhdGguam9pbihwYXRoLCBmaWxlLm5hbWUpLFxuICAgICAgICAgICAgICAgIG9wdHM6IEFzc2V0Q3JlYXRlT3B0aW9ucyA9IHtza2lwTWV0YTpmYWxzZX07XG4gICAgXG4gICAgICAgICAgICBpZiAoZmllbGRzWyduYW1lJ10gJiYgZmllbGRzWyduYW1lJ10gIT0gXCJcIikge1xuICAgICAgICAgICAgICAgIG9wdHMubmFtZSA9IGZpZWxkc1snbmFtZSddO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgaWYgKGZpZWxkc1snbWltZSddICYmIGZpZWxkc1snbWltZSddICE9IFwiXCIpIHtcbiAgICAgICAgICAgICAgICBvcHRzLm1pbWUgPSBmaWVsZHNbJ21pbWUnXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlYnVnKCdjcmVhdGUgZmlsZSBcIiVzXCIsIG9wdGlvbnMgXCIlalwiJywgZGVzdCwgb3B0cyk7XG4gICAgICAgICAgICBsZXQgYXNzZXQgPSBhd2FpdCB0aGlzLl9hc3NldHMuY3JlYXRlRnJvbVBhdGgoZmlsZS5wYXRoLCBkZXN0LCBvcHRzKTtcbiAgICBcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3dyaXRlSlNPTihyZXMsIGFzc2V0LCAyMDEpOyovXG4gICAgICAgICAgICBsZXQgY29udGVudFR5cGUgPSBjdHgucmVxLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddO1xuICAgICAgICAgICAgaWYgKCFjb250ZW50VHlwZSB8fCBjb250ZW50VHlwZS5pbmRleE9mKCdtdWx0aXBhcnQvZm9ybS1kYXRhJykgPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignbm90IG11bHRpZm9ybScpO1xuICAgICAgICAgICAgICAgIGxldCBxdWVyeSA9IGN0eC5xdWVyeTtcbiAgICAgICAgICAgICAgICBpZiAocXVlcnkuZmlsZW5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGxlbiA9IHBhcnNlSW50KGN0eC5nZXQoJ2NvbnRlbnQtbGVuZ3RoJykpLCB0eXBlID0gY29udGVudFR5cGU7XG4gICAgICAgICAgICAgICAgICAgIGxldCBwYXRoID0gcXVlcnkucGF0aCB8fCAnLyc7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXRoW3BhdGgubGVuZ3RoIC0gMV0gIT0gJy8nKVxuICAgICAgICAgICAgICAgICAgICAgICAgcGF0aCArPSAnLyc7XG4gICAgICAgICAgICAgICAgICAgIGxldCBhc3NldCA9IHlpZWxkIGNsaWVudC5jcmVhdGUoY3R4LnJlcSwgcGF0aCArIHF1ZXJ5LmZpbGVuYW1lLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtaW1lOiB0eXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZTogbGVuLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2tpcE1ldGE6IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBjdHgudHlwZSA9ICdqc29uJztcbiAgICAgICAgICAgICAgICAgICAgY3R4LmJvZHkgPSBhc3NldDtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjdHgudGhyb3coNDAwLCAnTm8gbmFtZSBzcGNpZmllZCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY3R4LnR5cGUgPSBcImpzb25cIjtcbiAgICAgICAgICAgIGxldCBib2R5ID0gY3R4LnJlcXVlc3QuYm9keTtcbiAgICAgICAgICAgIGxldCBmaWxlID0gYm9keS5maWxlcy5maWxlO1xuICAgICAgICAgICAgaWYgKGZpbGUgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGN0eC50aHJvdyg0MDMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IGZpZWxkcyA9IGJvZHkuZmllbGRzO1xuICAgICAgICAgICAgbGV0IHBhdGggPSBib2R5LmZpZWxkcy5wYXRoIHx8ICcvJywgZGVzdCA9IFBhdGguam9pbihwYXRoLCBmaWxlLm5hbWUpLCBvcHRzID0geyBza2lwTWV0YTogZmFsc2UgfTtcbiAgICAgICAgICAgIGlmIChmaWVsZHMubmFtZSAmJiBmaWVsZHMubmFtZSAhPSBcIlwiKSB7XG4gICAgICAgICAgICAgICAgb3B0cy5uYW1lID0gZmllbGRzLm5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZmllbGRzLm1pbWUgJiYgZmllbGRzLm1pbWUgIT0gXCJcIikge1xuICAgICAgICAgICAgICAgIG9wdHMubWltZSA9IGZpZWxkcy5taW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IGFzc2V0ID0geWllbGQgY2xpZW50LmNyZWF0ZUZyb21QYXRoKGZpbGUucGF0aCwgZGVzdCwgb3B0cyk7XG4gICAgICAgICAgICBjdHguc3RhdHVzID0gMjAxO1xuICAgICAgICAgICAgY3R4LmJvZHkgPSBhc3NldDtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHVwZGF0ZUFzc2V0KGN0eCkge1xuICAgIH1cbiAgICBmdW5jdGlvbiBkZWxldGVBc3NldChjdHgpIHtcbiAgICB9XG4gICAgZnVuY3Rpb24gX3dyaXRlTGlua3NIZWFkZXIoY3R4LCBsaW5rcykge1xuICAgICAgICBsZXQgdXJsID0gY3R4LnVybDtcbiAgICAgICAgdXJsID0gY3R4LmdldCgnaG9zdCcpICsgdXJsOyAvLyArICAodXJsLmluZGV4T2YoJz8nKSA9PSAtMSA/IFwiP1wiIDogXCImXCIpICsgJ3BhZ2U9JztcbiAgICAgICAgdXJsID0gXCJodHRwOi8vXCIgKyB1cmw7XG4gICAgICAgIGxldCB1ID0gVVJMLnBhcnNlKHVybCwgdHJ1ZSk7XG4gICAgICAgIGlmICh1LnF1ZXJ5KSB7XG4gICAgICAgICAgICAvKmxldCBxdWVyeSA9IFFzLnBhcnNlKHUucXVlcnkpOyovXG4gICAgICAgICAgICBpZiAodS5xdWVyeS5wYWdlKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHUucXVlcnkucGFnZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vdS5xdWVyeSA9IFFzLnN0cmluZ2lmeShxdWVyeSk7XG4gICAgICAgICAgICB1LnNlYXJjaCA9IG51bGw7XG4gICAgICAgICAgICB1cmwgPSBVUkwuZm9ybWF0KHUpO1xuICAgICAgICAgICAgdXJsICs9IFwiJnBhZ2U9XCI7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB1cmwgKz0gJz9wYWdlPSc7XG4gICAgICAgIH1cbiAgICAgICAgY3R4LnNldCgnTGluaycsIE9iamVjdC5rZXlzKGxpbmtzKS5tYXAoZnVuY3Rpb24gKHJlbCkge1xuICAgICAgICAgICAgcmV0dXJuICc8JyArIHVybCArIGxpbmtzW3JlbF0gKyAnPjsgcmVsPVwiJyArIHJlbCArICdcIic7XG4gICAgICAgIH0pLmpvaW4oJywgJykpO1xuICAgIH1cbn1cbmV4cG9ydHMuQXBwID0gQXBwO1xuIiwiZGVjbGFyZSB2YXIgcmVxdWlyZTtcblxuaW1wb3J0ICogYXMgS29hIGZyb20gJ2tvYSc7XG5pbXBvcnQgKiBhcyBSb3V0ZXIgZnJvbSAna29hLXJvdXRlcic7XG5cbmltcG9ydCB7QXNzZXRzLCBBc3NldENyZWF0ZU9wdGlvbnN9IGZyb20gJy4uL2luZGV4JztcbmltcG9ydCAqIGFzIFBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBVUkwgZnJvbSAndXJsJztcblxuY29uc3QgY29udmVydCA9IHJlcXVpcmUoJ2tvYS1jb252ZXJ0JyksXG5cdGNvcnMgPSByZXF1aXJlKCdrb2EtY29ycycpLFxuXHRib2R5ID0gcmVxdWlyZSgna29hLWJvZHknKTtcblxuZXhwb3J0IGludGVyZmFjZSBBc3NldHNSb3V0ZXJPcHRpb25zIHtcbiAgICBwcmVmaXg/OiBzdHJpbmdcbn1cblxuZnVuY3Rpb24gdG9Cb29sZWFuKHN0cjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhflsndHJ1ZScsICdUUlVFJywndCcsICd5JywnaicsJ3llcyddLmluZGV4T2Yoc3RyKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gQXBwKGNsaWVudDpBc3NldHMsIG9wdGlvbnM6IEFzc2V0c1JvdXRlck9wdGlvbnMgPSB7fVx0KSB7XG5cblx0bGV0IGFwcCA9IG5ldyBLb2EoKTtcblxuXHRsZXQgcm91dGVyID0gbmV3IFJvdXRlcigpO1xuXG5cdGxldCBwID0gb3B0aW9ucy5wcmVmaXh8fCAnLydcblxuXHRcblx0cm91dGVyLnBvc3QocCwgY29udmVydChib2R5KHttdWx0aXBhcnQ6dHJ1ZX0pKSwgY3JlYXRlQXNzZXQpO1xuXHRyb3V0ZXIuZ2V0KHAsIGxpc3RBc3NldHMpO1xuXHRyb3V0ZXIuZ2V0KFBhdGguam9pbihwLCAnKicpLCBnZXRBc3NldCk7XG5cdFxuXHRyb3V0ZXIuZGVsKFBhdGguam9pbihwLCAnKicpLCBkZWxldGVBc3NldCk7XG5cblx0YXBwLnVzZShjb252ZXJ0KGNvcnMoe1xuXHRcdG9yaWdpbjogJyonLFxuXHRcdGV4cG9zZTogWydMaW5rJ11cblx0XHQvL2V4cG9zZTogJ0NvbnRlbnQtVHlwZSdcblx0fSkpKVxuXG5cdFxuXHRhcHAudXNlKHJvdXRlci5yb3V0ZXMoKSk7XG5cdC8vYXBwLnVzZShyb3V0ZXIuYWxsb3dlZE1ldGhvZHMoKSlcblx0Ly9yb3V0ZXIucHV0KCcvJylcblx0cmV0dXJuIGFwcDtcblxuXG5cblx0YXN5bmMgZnVuY3Rpb24gbGlzdEFzc2V0cyhjdHg6IEtvYS5Db250ZXh0KSB7XG5cdFx0Y3R4LnR5cGUgPSAnanNvbic7XG5cdFx0bGV0IHF1ZXJ5ID0gY3R4LnF1ZXJ5O1xuXG5cdFx0aWYgKHF1ZXJ5LmlkKSB7XG5cdFx0XHRsZXQgYXNzZXQgPSBhd2FpdCBjbGllbnQuZ2V0QnlJZChxdWVyeS5pZCk7XG5cblx0XHRcdGlmICghYXNzZXQpIHtcblx0XHRcdFx0Y3R4LnRocm93KDQwNCwge21lc3NhZ2U6J25vdCBmb3VuZCd9KTtcblx0XHRcdH1cblxuXHRcdFx0Y3R4LmJvZHkgPSBhc3NldDtcblx0XHR9XG5cblx0XHRsZXQgcGFnZSA9IDEsIGxpbWl0ID0gMTAwO1xuICAgICAgICBpZiAocXVlcnkucGFnZSkge1xuICAgICAgICAgICAgbGV0IGkgPSBwYXJzZUludChxdWVyeS5wYWdlKTtcbiAgICAgICAgICAgIGlmICghaXNOYU4oaSkpIHBhZ2UgPSBpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHF1ZXJ5LmxpbWl0KSB7XG4gICAgICAgICAgICBsZXQgaSA9IHBhcnNlSW50KHF1ZXJ5LmxpbWl0KTtcbiAgICAgICAgICAgIGlmICghaXNOYU4oaSkpIGxpbWl0ID0gaTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYWdlIDw9IDApIHBhZ2UgPSAxO1xuXG4gICAgICAgIGxldCByZXN1bHQ7XG4gICAgICAgIGlmIChxdWVyeS5xKSB7XG4gICAgICAgICAgICByZXN1bHQgPSBhd2FpdCBjbGllbnQucXVlcnkocXVlcnkucSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgY291bnQgPSBhd2FpdCBjbGllbnQubWV0YVN0b3JlLmNvdW50KCk7XG4gICAgICAgICAgICBsZXQgcGFnZXMgPSBNYXRoLmNlaWwoY291bnQgLyBsaW1pdCk7XG4gICAgICAgICAgICBsZXQgb2Zmc2V0ID0gbGltaXQgKiAocGFnZSAtIDEpO1xuXG4gICAgICAgICAgICBpZiAob2Zmc2V0ID4gY291bnQpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBbXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gYXdhaXQgY2xpZW50Lmxpc3Qoe1xuICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IG9mZnNldCxcbiAgICAgICAgICAgICAgICAgICAgbGltaXQ6IGxpbWl0XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBsaW5rczogYW55ID0ge1xuICAgICAgICAgICAgICAgIGZpcnN0OiAxLFxuICAgICAgICAgICAgICAgIGxhc3Q6IHBhZ2VzXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAocGFnZSA+IDEpIGxpbmtzLnByZXYgPSBwYWdlIC0gMTtcbiAgICAgICAgICAgIGlmIChwYWdlIDwgcGFnZXMpIGxpbmtzLm5leHQgPSBwYWdlICsgMTtcblxuICAgICAgICAgICAgX3dyaXRlTGlua3NIZWFkZXIoY3R4LCBsaW5rcyk7XG5cbiAgICAgICAgfVxuXHRcdFxuICAgICAgICBjdHguYm9keSA9IHJlc3VsdDtcblx0XG5cdH1cblxuXG5cdGFzeW5jIGZ1bmN0aW9uIGdldEFzc2V0KGN0eDogS29hLkNvbnRleHQpIHtcblx0XHRsZXQgcXVlcnkgPSBjdHgucXVlcnlcblxuXHRcdGxldCBwYXRoID0gY3R4LnBhdGg7XG5cbiAgICAgICAgaWYgKHBhdGhbMF0gIT09ICcvJykgcGF0aCA9IFwiL1wiICsgcGF0aDtcbiAgICAgICAgXG4gICAgICAgIGxldCBhc3NldCA9IChhd2FpdCBjbGllbnQuZ2V0QnlQYXRoKHBhdGgpKTtcbiAgICAgICAgY29uc29sZS5sb2coYXNzZXQpXG4gICAgICAgIGlmICghYXNzZXQpIGN0eC50aHJvdyg0MDQpO1xuXG4gICAgICAgIGlmICh0b0Jvb2xlYW4ocXVlcnkubWV0YSkpIHtcbiAgICAgICAgICAgIGN0eC5ib2R5ID0gYXNzZXQ7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAvL3JldHVybiBhd2FpdCB0aGlzLl93cml0ZUpTT04ocmVzLCBhc3NldCwgMjAwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGN0eC50eXBlID0gYXNzZXQubWltZTtcblxuICAgICAgICAvL3Jlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIGFzc2V0Lm1pbWUpO1xuICAgICAgICAvL3Jlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtTGVuZ3RoJywgYXNzZXQuc2l6ZSArIFwiXCIpO1xuXG4gICAgICAgIGlmICh0b0Jvb2xlYW4ocXVlcnkuZG93bmxvYWQpKSB7XG5cbiAgICAgICAgICAgIGN0eC5zZXQoJ0NvbnRlbnQtRGlzcG9zaXRpb24nLCAnYXR0YWNobWVudDsgZmlsZW5hbWU9JyArIGFzc2V0LmZpbGVuYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBvdXRTdHJlYW07XG4gICAgICAgIGlmICh0b0Jvb2xlYW4ocXVlcnkudGh1bWJuYWlsKSkge1xuICAgICAgICAgICAgY3R4LnNldCgnQ29udGVudC1UeXBlJywgJ2ltYWdlL3BuZycpO1xuICAgICAgICAgICAgb3V0U3RyZWFtID0gYXdhaXQgY2xpZW50LnRodW1ibmFpbChhc3NldCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhvdXRTdHJlYW0pXG4gICAgICAgICAgICBpZiAob3V0U3RyZWFtID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjdHgudGhyb3coNDAwLCB7XG4gICAgICAgICAgICAgICAgXHRtZXNzYWdlOiAnQ2Fubm90IGdlbmVyYXRlIHRodW1ibmFpbCBmb3IgbWltZXR5cGU6ICcgKyBhc3NldC5taW1lXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBIdHRwRXJyb3IoJ0Nhbm5vdCBnZW5lcmF0ZSB0aHVtYm5haWwgZm9yIG1pbWV0eXBlOiAnICsgYXNzZXQubWltZSAsIDQwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgb3V0U3RyZWFtID0gYXdhaXQgY2xpZW50LnN0cmVhbShhc3NldCk7XG4gICAgICAgIH1cblxuICAgICAgICBjdHguc3RhdHVzID0gMjAwO1xuICAgICAgICBjdHguYm9keSA9IG91dFN0cmVhbTtcblx0fVxuXG5cdGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUFzc2V0KGN0eDogS29hLkNvbnRleHQpIHtcblxuXHRcdC8qbGV0IGNvbnRlbnRUeXBlID0gY3R4LmdldCgnY29udGVudC10eXBlJylcbiAgICAgICAgaWYgKCFjb250ZW50VHlwZSB8fCBjb250ZW50VHlwZS5pbmRleE9mKCdtdWx0aXBhcnQvZm9ybS1kYXRhJykgPT0gLTEpIHtcbiAgICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKCdub3QgbXVsdGlmb3JtJyk7XG4gICAgICAgICAgICBsZXQgcXVlcnkgPSBjdHgucXVlcnlcblxuICAgICAgICAgICAgaWYgKHF1ZXJ5LmZpbGVuYW1lKSB7XG5cbiAgICAgICAgICAgICAgICBsZXQgbGVuID0gcGFyc2VJbnQoY3R4LmdldCgnY29udGVudC1sZW5ndGgnKSksXG4gICAgICAgICAgICAgICAgICAgIHR5cGUgOiBzdHJpbmcgPSBjb250ZW50VHlwZTtcblxuICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICBsZXQgcGF0aCA9IHF1ZXJ5LnBhdGh8fCcvJ1xuICAgICAgICAgICAgICAgIGlmIChwYXRoW3BhdGgubGVuZ3RoIC0gMV0gIT0gJy8nKSBwYXRoICs9ICcvJztcbiAgICAgICAgICAgICAgICBsZXQgYXNzZXQgPSBhd2FpdCB0aGlzLl9hc3NldHMuY3JlYXRlKHJlcSwgcGF0aCArIHF1ZXJ5LmZpbGVuYW1lLCB7XG4gICAgICAgICAgICAgICAgICAgIG1pbWU6IHR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHNpemU6IGxlbixcbiAgICAgICAgICAgICAgICAgICAgc2tpcE1ldGE6IGZhbHNlXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBjdHgudHlwZSA9ICdqc29uJztcbiAgICAgICAgICAgICAgICBjdHguYm9keSA9IGFzc2V0O1xuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBtdWx0aWZvcm0nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB7ZmlsZXMsIGZpZWxkc30gPSBhd2FpdCB0aGlzLl9yZWFkRm9ybShyZXEpO1xuXG4gICAgICAgIGxldCBmaWxlOiBmb3JtaWRhYmxlLkZpbGU7XG4gICAgICAgIGZvciAobGV0IGsgaW4gZmlsZXMpIHtcbiAgICAgICAgICAgIGZpbGUgPSBmaWxlc1trXTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFmaWxlKSB0aHJvdyBuZXcgRXJyb3IoJ25vdCBmaWxlJyk7XG5cblxuICAgICAgICBsZXQgcGF0aCA9IGZpZWxkc1sncGF0aCddfHwgJy8nLFxuICAgICAgICAgICAgZGVzdCA9IFBhdGguam9pbihwYXRoLCBmaWxlLm5hbWUpLFxuICAgICAgICAgICAgb3B0czogQXNzZXRDcmVhdGVPcHRpb25zID0ge3NraXBNZXRhOmZhbHNlfTtcblxuICAgICAgICBpZiAoZmllbGRzWyduYW1lJ10gJiYgZmllbGRzWyduYW1lJ10gIT0gXCJcIikge1xuICAgICAgICAgICAgb3B0cy5uYW1lID0gZmllbGRzWyduYW1lJ107XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZmllbGRzWydtaW1lJ10gJiYgZmllbGRzWydtaW1lJ10gIT0gXCJcIikge1xuICAgICAgICAgICAgb3B0cy5taW1lID0gZmllbGRzWydtaW1lJ107XG4gICAgICAgIH1cbiAgICAgICAgZGVidWcoJ2NyZWF0ZSBmaWxlIFwiJXNcIiwgb3B0aW9ucyBcIiVqXCInLCBkZXN0LCBvcHRzKTtcbiAgICAgICAgbGV0IGFzc2V0ID0gYXdhaXQgdGhpcy5fYXNzZXRzLmNyZWF0ZUZyb21QYXRoKGZpbGUucGF0aCwgZGVzdCwgb3B0cyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fd3JpdGVKU09OKHJlcywgYXNzZXQsIDIwMSk7Ki9cbiAgICAgICAgXG4gICAgICAgIGxldCBjb250ZW50VHlwZSA9IGN0eC5yZXEuaGVhZGVyc1snY29udGVudC10eXBlJ107XG4gICAgICAgIGlmICghY29udGVudFR5cGUgfHwgY29udGVudFR5cGUuaW5kZXhPZignbXVsdGlwYXJ0L2Zvcm0tZGF0YScpID09IC0xKSB7XG4gICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignbm90IG11bHRpZm9ybScpO1xuICAgICAgICAgICAgbGV0IHF1ZXJ5ID0gY3R4LnF1ZXJ5XG5cbiAgICAgICAgICAgIGlmIChxdWVyeS5maWxlbmFtZSkge1xuXG4gICAgICAgICAgICAgICAgbGV0IGxlbiA9IHBhcnNlSW50KGN0eC5nZXQoJ2NvbnRlbnQtbGVuZ3RoJykpLFxuICAgICAgICAgICAgICAgICAgICB0eXBlIDogc3RyaW5nID0gY29udGVudFR5cGU7XG5cbiAgICAgICAgICAgICAgICBsZXQgcGF0aCA9IHF1ZXJ5LnBhdGh8fCcvJ1xuICAgICAgICAgICAgICAgIGlmIChwYXRoW3BhdGgubGVuZ3RoIC0gMV0gIT0gJy8nKSBwYXRoICs9ICcvJztcbiAgICAgICAgICAgICAgICBsZXQgYXNzZXQgPSBhd2FpdCBjbGllbnQuY3JlYXRlKGN0eC5yZXEsIHBhdGggKyBxdWVyeS5maWxlbmFtZSwge1xuICAgICAgICAgICAgICAgICAgICBtaW1lOiB0eXBlLFxuICAgICAgICAgICAgICAgICAgICBzaXplOiBsZW4sXG4gICAgICAgICAgICAgICAgICAgIHNraXBNZXRhOiBmYWxzZVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgY3R4LnR5cGUgPSAnanNvbic7XG4gICAgICAgICAgICAgICAgY3R4LmJvZHkgPSBhc3NldDtcbiAgICAgICAgICAgICAgICByZXR1cm5cblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY3R4LnRocm93KDQwMCwgJ05vIG5hbWUgc3BjaWZpZWQnKTtcbiAgICAgICAgfVxuXG5cblxuICAgICAgICBjdHgudHlwZSA9IFwianNvblwiO1xuXG4gICAgICAgXHRsZXQgYm9keSA9IChjdHgucmVxdWVzdCBhcyBhbnkpLmJvZHk7XG5cbiAgICAgICBcdGxldCBmaWxlID0gYm9keS5maWxlcy5maWxlO1xuICAgICAgICBpZiAoZmlsZSA9PSBudWxsKSB7XG4gICAgICAgIFx0Y3R4LnRocm93KDQwMyk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGZpZWxkcyA9IGJvZHkuZmllbGRzO1xuXG4gICAgICAgXHRsZXQgcGF0aCA9IGJvZHkuZmllbGRzLnBhdGh8fCAnLycsXG4gICAgICAgXHRcdGRlc3QgPSBQYXRoLmpvaW4ocGF0aCwgZmlsZS5uYW1lKSxcbiAgICAgICBcdFx0b3B0czogQXNzZXRDcmVhdGVPcHRpb25zID0ge3NraXBNZXRhOiBmYWxzZX07XG5cbiAgICAgICBcdGlmIChmaWVsZHMubmFtZSAmJiBmaWVsZHMubmFtZSAhPSBcIlwiKSB7XG4gICAgICAgXHRcdG9wdHMubmFtZSA9IGZpZWxkcy5uYW1lO1xuICAgICAgIFx0fVxuXG4gICAgICAgXHRpZiAoZmllbGRzLm1pbWUgJiYgZmllbGRzLm1pbWUgIT0gXCJcIikge1xuICAgICAgIFx0XHRvcHRzLm1pbWUgPSBmaWVsZHMubWltZTtcbiAgICAgICBcdH1cblxuICAgICAgICBsZXQgYXNzZXQgPSBhd2FpdCBjbGllbnQuY3JlYXRlRnJvbVBhdGgoZmlsZS5wYXRoLCBkZXN0LCBvcHRzKTtcblxuICAgICAgICBjdHguc3RhdHVzID0gMjAxO1xuICAgICAgICBjdHguYm9keSA9IGFzc2V0O1xuXG5cdH1cblxuXHRmdW5jdGlvbiB1cGRhdGVBc3NldChjdHg6IEtvYS5Db250ZXh0KSB7XG5cblx0fVxuXG5cdGZ1bmN0aW9uIGRlbGV0ZUFzc2V0KGN0eDpLb2EuQ29udGV4dCkge1xuXG5cdH1cblxuXHRmdW5jdGlvbiBfd3JpdGVMaW5rc0hlYWRlcihjdHg6IEtvYS5Db250ZXh0LCBsaW5rczoge3ByZXY/Om51bWJlciwgbmV4dD86bnVtYmVyLCBsYXN0PzpudW1iZXIsIGZpcnN0PzpudW1iZXJ9KSB7XG5cbiAgICAgICAgbGV0IHVybCA9IGN0eC51cmw7XG5cbiAgICAgICAgdXJsID0gY3R4LmdldCgnaG9zdCcpICsgdXJsIC8vICsgICh1cmwuaW5kZXhPZignPycpID09IC0xID8gXCI/XCIgOiBcIiZcIikgKyAncGFnZT0nO1xuXG4gICAgICAgIHVybCA9IFwiaHR0cDovL1wiICsgdXJsXG4gICAgICAgIGxldCB1ID0gVVJMLnBhcnNlKHVybCwgdHJ1ZSk7XG5cbiAgICAgICAgaWYgKHUucXVlcnkpIHtcbiAgICAgICAgICAgIC8qbGV0IHF1ZXJ5ID0gUXMucGFyc2UodS5xdWVyeSk7Ki9cbiAgICAgICAgICAgIGlmICh1LnF1ZXJ5LnBhZ2UpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgdS5xdWVyeS5wYWdlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvL3UucXVlcnkgPSBRcy5zdHJpbmdpZnkocXVlcnkpO1xuICAgICAgICAgICAgdS5zZWFyY2ggPSBudWxsO1xuICAgICAgICAgICAgdXJsID0gVVJMLmZvcm1hdCh1KTtcbiAgICAgICAgICAgIHVybCArPSBcIiZwYWdlPVwiO1xuICAgICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB1cmwgKz0gJz9wYWdlPSc7XG4gICAgICAgIH1cblxuICAgICAgICBjdHguc2V0KCdMaW5rJywgT2JqZWN0LmtleXMobGlua3MpLm1hcChmdW5jdGlvbihyZWwpe1xuICAgICAgICAgICAgcmV0dXJuICc8JyArIHVybCArIGxpbmtzW3JlbF0gKyAnPjsgcmVsPVwiJyArIHJlbCArICdcIic7XG4gICAgICAgIH0pLmpvaW4oJywgJykpO1xuICAgICAgICBcbiAgICB9XG5cblxufVxuXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
