"use strict";

var __awaiter = undefined && undefined.__awaiter || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) {
            try {
                step(generator.next(value));
            } catch (e) {
                reject(e);
            }
        }
        function rejected(value) {
            try {
                step(generator.throw(value));
            } catch (e) {
                reject(e);
            }
        }
        function step(result) {
            result.done ? resolve(result.value) : new P(function (resolve) {
                resolve(result.value);
            }).then(fulfilled, rejected);
        }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
var utils_1 = require('../utils');
var index_1 = require('../index');
var server_1 = require('../http/server');
var http = require('http');
var fs = require('mz/fs');
var Path = require('path');
var Debug = require('debug');
var debug = Debug('assets:cli:server');
var etag = require('etag');
function serverCommand(program) {
    var cmd = program.command('http').action(function () {
        var options = utils_1.pick(cmd, ['port', 'web', 'config']);
        try {
            startServer(options);
        } catch (e) {
            console.log('Could not start server: %s', e.message);
            process.exit(-1);
        }
    });
    cmd.option("-p, --port <port>", "port to use [default: 5000]", 5000).option('-w, --web', 'web client').option('-c, --config <path>');
}
exports.serverCommand = serverCommand;
function startServer(options) {
    var server = void 0;
    var router = void 0;
    var clean = function clean() {
        process.stdout.write("Exiting ... ");
        if (server) server.close();
        process.stdout.write('done\n');
        process.exit(0);
    };
    var config = {};
    if (options.config) {
        var configPath = options.config;
        if (!Path.isAbsolute(configPath)) configPath = Path.resolve(options.config);
        config = require(configPath);
        console.log('Using config file: %s', configPath);
    }
    var assets = new index_1.Assets(config);
    var prefix = options.web ? '/files' : '/';
    router = new server_1.AssetsRouter(assets, {
        prefix: prefix
    });
    server = http.createServer(function (req, res) {
        router.middleware(req, res, function () {
            if (options.web) {
                debug('handle client');
                return handleClient(assets, req, res).catch(function (e) {
                    console.error(e.stack);
                    process.exit(-1);
                });
            }
            res.writeHead(404);
            res.end();
        });
    });
    assets.initialize().then(function () {
        console.log('Starting server on port %s', options.port);
        server.listen(options.port);
    }).catch(function (e) {
        console.error('Error: ', e);
        process.exit(-1);
    });
    process.on('SIGINT', clean);
}
var ASSETS_PATH = Path.resolve(__dirname, '../..', 'node_modules/assets.gallery/dist');
function handleClient(assets, req, res) {
    return __awaiter(this, void 0, Promise, function* () {
        var stream = void 0,
            mime = "text/html",
            stats = void 0;
        var path = void 0;
        switch (req.url) {
            case '/js/assets-gallery.js':
                path = Path.join(ASSETS_PATH, 'js', 'assets-gallery.js');
                mime = 'application/javascript';
                break;
            case '/css/assets-gallery.css':
                path = Path.join(ASSETS_PATH, 'css', 'assets-gallery.css');
                mime = 'text/css';
                break;
            case '/images/assets-mimetypes.png':
                path = Path.join(ASSETS_PATH, 'images', 'assets-mimetypes.png');
                mime = 'image/png';
                break;
            case '/images/assets-mimetypes@2x.png':
                path = Path.join(ASSETS_PATH, 'images', 'assets-mimetypes@2x.png');
                mime = 'image/png';
                break;
            case '/images/assets-loader.gif':
                path = Path.join(ASSETS_PATH, 'images', 'assets-loader.gif');
                mime = 'image/gif';
                break;
            case '/images/assets-remove.png':
                path = Path.join(ASSETS_PATH, 'images', 'assets-remove.png');
                mime = 'image/png';
                break;
            default:
                path = Path.resolve(__dirname, '../../resources/index.html');
                mime = 'text/html';
        }
        stats = yield fs.stat(path);
        stream = fs.createReadStream(path);
        res.writeHead(200, {
            'Content-Type': mime,
            'Content-Length': stats.size
        });
        stream.pipe(res);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsaS9zZXJ2ZXIuanMiLCJjbGkvc2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUksWUFBWSxTQUFDLElBQVEsVUFBSyxTQUFMLElBQW1CLFVBQVUsT0FBVixFQUFtQixVQUFuQixFQUErQixDQUEvQixFQUFrQyxTQUFsQyxFQUE2QztBQUNyRixXQUFPLEtBQUssTUFBTSxJQUFJLE9BQUosQ0FBTixDQUFMLENBQXlCLFVBQVUsT0FBVixFQUFtQixNQUFuQixFQUEyQjtBQUN2RCxpQkFBUyxTQUFULENBQW1CLEtBQW5CLEVBQTBCO0FBQUUsZ0JBQUk7QUFBRSxxQkFBSyxVQUFVLElBQVYsQ0FBZSxLQUFmLENBQUwsRUFBRjthQUFKLENBQXFDLE9BQU8sQ0FBUCxFQUFVO0FBQUUsdUJBQU8sQ0FBUCxFQUFGO2FBQVY7U0FBakU7QUFDQSxpQkFBUyxRQUFULENBQWtCLEtBQWxCLEVBQXlCO0FBQUUsZ0JBQUk7QUFBRSxxQkFBSyxVQUFVLEtBQVYsQ0FBZ0IsS0FBaEIsQ0FBTCxFQUFGO2FBQUosQ0FBc0MsT0FBTyxDQUFQLEVBQVU7QUFBRSx1QkFBTyxDQUFQLEVBQUY7YUFBVjtTQUFqRTtBQUNBLGlCQUFTLElBQVQsQ0FBYyxNQUFkLEVBQXNCO0FBQUUsbUJBQU8sSUFBUCxHQUFjLFFBQVEsT0FBTyxLQUFQLENBQXRCLEdBQXNDLElBQUksQ0FBSixDQUFNLFVBQVUsT0FBVixFQUFtQjtBQUFFLHdCQUFRLE9BQU8sS0FBUCxDQUFSLENBQUY7YUFBbkIsQ0FBTixDQUFxRCxJQUFyRCxDQUEwRCxTQUExRCxFQUFxRSxRQUFyRSxDQUF0QyxDQUFGO1NBQXRCO0FBQ0EsYUFBSyxDQUFDLFlBQVksVUFBVSxLQUFWLENBQWdCLE9BQWhCLEVBQXlCLFVBQXpCLENBQVosQ0FBRCxDQUFtRCxJQUFuRCxFQUFMLEVBSnVEO0tBQTNCLENBQWhDLENBRHFGO0NBQTdDO0FDRDVDLElBQUEsVUFBQSxRQUFtQixVQUFuQixDQUFBO0FBQ0Es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c0JBSEo7QUFMSixpQkFTUyw4QkFBTDtBQUNJLHVCQUFPLEtBQUssSUFBTCxDQUFVLFdBQVYsRUFBdUIsUUFBdkIsRUFBaUMsc0JBQWpDLENBQVAsQ0FESjtBQUVJLHVCQUFPLFdBQVAsQ0FGSjtBQUdJLHNCQUhKO0FBVEosaUJBYVMsaUNBQUw7QUFDSSx1QkFBTyxLQUFLLElBQUwsQ0FBVSxXQUFWLEVBQXVCLFFBQXZCLEVBQWlDLHlCQUFqQyxDQUFQLENBREo7QUFFSSx1QkFBTyxXQUFQLENBRko7QUFHSSxzQkFISjtBQWJKLGlCQWlCUywyQkFBTDtBQUNJLHVCQUFPLEtBQUssSUFBTCxDQUFVLFdBQVYsRUFBdUIsUUFBdkIsRUFBaUMsbUJBQWpDLENBQVAsQ0FESjtBQUVJLHVCQUFPLFdBQVAsQ0FGSjtBQUdJLHNCQUhKO0FBakJKLGlCQXFCUywyQkFBTDtBQUNJLHVCQUFPLEtBQUssSUFBTCxDQUFVLFdBQVYsRUFBdUIsUUFBdkIsRUFBaUMsbUJBQWpDLENBQVAsQ0FESjtBQUVJLHVCQUFPLFdBQVAsQ0FGSjtBQUdJLHNCQUhKO0FBckJKO0FBMEJRLHVCQUFPLEtBQUssT0FBTCxDQUFhLFNBQWIsRUFBd0IsNEJBQXhCLENBQVAsQ0FESjtBQUVJLHVCQUFPLFdBQVAsQ0FGSjtBQXpCSixTRHhCcUQ7QUNzRHJELGdCQUFRLE1BQU0sR0FBRyxJQUFILENBQVEsSUFBUixDQUFOLENEdEQ2QztBQ3dEckQsaUJBQVMsR0FBRyxnQkFBSCxDQUFvQixJQUFwQixDQUFULENEeERxRDtBQzBEckQsWUFBSSxTQUFKLENBQWMsR0FBZCxFQUFtQjtBQUNmLDRCQUFnQixJQUFoQjtBQUNBLDhCQUFrQixNQUFNLElBQU47U0FGdEIsRUQxRHFEO0FDZ0VyRCxlQUFPLElBQVAsQ0FBWSxHQUFaLEVEaEVxRDtLQUFiLENBQXhDLENDbUIwRjtDQUE5RiIsImZpbGUiOiJjbGkvc2VydmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci50aHJvdyh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5jb25zdCB1dGlsc18xID0gcmVxdWlyZSgnLi4vdXRpbHMnKTtcbmNvbnN0IGluZGV4XzEgPSByZXF1aXJlKCcuLi9pbmRleCcpO1xuY29uc3Qgc2VydmVyXzEgPSByZXF1aXJlKCcuLi9odHRwL3NlcnZlcicpO1xuY29uc3QgaHR0cCA9IHJlcXVpcmUoJ2h0dHAnKTtcbmNvbnN0IGZzID0gcmVxdWlyZSgnbXovZnMnKTtcbmNvbnN0IFBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBEZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJyk7XG5jb25zdCBkZWJ1ZyA9IERlYnVnKCdhc3NldHM6Y2xpOnNlcnZlcicpO1xuY29uc3QgZXRhZyA9IHJlcXVpcmUoJ2V0YWcnKTtcbmZ1bmN0aW9uIHNlcnZlckNvbW1hbmQocHJvZ3JhbSkge1xuICAgIHZhciBjbWQgPSBwcm9ncmFtLmNvbW1hbmQoJ2h0dHAnKVxuICAgICAgICAuYWN0aW9uKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB1dGlsc18xLnBpY2soY21kLCBbJ3BvcnQnLCAnd2ViJywgJ2NvbmZpZyddKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHN0YXJ0U2VydmVyKG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnQ291bGQgbm90IHN0YXJ0IHNlcnZlcjogJXMnLCBlLm1lc3NhZ2UpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGNtZC5vcHRpb24oXCItcCwgLS1wb3J0IDxwb3J0PlwiLCBcInBvcnQgdG8gdXNlIFtkZWZhdWx0OiA1MDAwXVwiLCA1MDAwKVxuICAgICAgICAub3B0aW9uKCctdywgLS13ZWInLCAnd2ViIGNsaWVudCcpXG4gICAgICAgIC5vcHRpb24oJy1jLCAtLWNvbmZpZyA8cGF0aD4nKTtcbn1cbmV4cG9ydHMuc2VydmVyQ29tbWFuZCA9IHNlcnZlckNvbW1hbmQ7XG5mdW5jdGlvbiBzdGFydFNlcnZlcihvcHRpb25zKSB7XG4gICAgbGV0IHNlcnZlcjtcbiAgICBsZXQgcm91dGVyO1xuICAgIGNvbnN0IGNsZWFuID0gKCkgPT4ge1xuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShcIkV4aXRpbmcgLi4uIFwiKTtcbiAgICAgICAgaWYgKHNlcnZlcilcbiAgICAgICAgICAgIHNlcnZlci5jbG9zZSgpO1xuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnZG9uZVxcbicpO1xuICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgfTtcbiAgICBsZXQgY29uZmlnID0ge307XG4gICAgaWYgKG9wdGlvbnMuY29uZmlnKSB7XG4gICAgICAgIGxldCBjb25maWdQYXRoID0gb3B0aW9ucy5jb25maWc7XG4gICAgICAgIGlmICghUGF0aC5pc0Fic29sdXRlKGNvbmZpZ1BhdGgpKVxuICAgICAgICAgICAgY29uZmlnUGF0aCA9IFBhdGgucmVzb2x2ZShvcHRpb25zLmNvbmZpZyk7XG4gICAgICAgIGNvbmZpZyA9IHJlcXVpcmUoY29uZmlnUGF0aCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdVc2luZyBjb25maWcgZmlsZTogJXMnLCBjb25maWdQYXRoKTtcbiAgICB9XG4gICAgbGV0IGFzc2V0cyA9IG5ldyBpbmRleF8xLkFzc2V0cyhjb25maWcpO1xuICAgIGxldCBwcmVmaXggPSBvcHRpb25zLndlYiA/ICcvZmlsZXMnIDogJy8nO1xuICAgIHJvdXRlciA9IG5ldyBzZXJ2ZXJfMS5Bc3NldHNSb3V0ZXIoYXNzZXRzLCB7XG4gICAgICAgIHByZWZpeDogcHJlZml4XG4gICAgfSk7XG4gICAgc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgIHJvdXRlci5taWRkbGV3YXJlKHJlcSwgcmVzLCAoKSA9PiB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy53ZWIpIHtcbiAgICAgICAgICAgICAgICBkZWJ1ZygnaGFuZGxlIGNsaWVudCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVDbGllbnQoYXNzZXRzLCByZXEsIHJlcykuY2F0Y2goZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjayk7XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXMud3JpdGVIZWFkKDQwNCk7XG4gICAgICAgICAgICByZXMuZW5kKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIGFzc2V0cy5pbml0aWFsaXplKCkudGhlbigoKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdTdGFydGluZyBzZXJ2ZXIgb24gcG9ydCAlcycsIG9wdGlvbnMucG9ydCk7XG4gICAgICAgIHNlcnZlci5saXN0ZW4ob3B0aW9ucy5wb3J0KTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3I6ICcsIGUpO1xuICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgIH0pO1xuICAgIHByb2Nlc3Mub24oJ1NJR0lOVCcsIGNsZWFuKTtcbn1cbmNvbnN0IEFTU0VUU19QQVRIID0gUGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uLy4uJywgJ25vZGVfbW9kdWxlcy9hc3NldHMuZ2FsbGVyeS9kaXN0Jyk7XG5mdW5jdGlvbiBoYW5kbGVDbGllbnQoYXNzZXRzLCByZXEsIHJlcykge1xuICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCBQcm9taXNlLCBmdW5jdGlvbiogKCkge1xuICAgICAgICBsZXQgc3RyZWFtLCBtaW1lID0gXCJ0ZXh0L2h0bWxcIiwgc3RhdHM7XG4gICAgICAgIGxldCBwYXRoO1xuICAgICAgICBzd2l0Y2ggKHJlcS51cmwpIHtcbiAgICAgICAgICAgIGNhc2UgJy9qcy9hc3NldHMtZ2FsbGVyeS5qcyc6XG4gICAgICAgICAgICAgICAgcGF0aCA9IFBhdGguam9pbihBU1NFVFNfUEFUSCwgJ2pzJywgJ2Fzc2V0cy1nYWxsZXJ5LmpzJyk7XG4gICAgICAgICAgICAgICAgbWltZSA9ICdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJy9jc3MvYXNzZXRzLWdhbGxlcnkuY3NzJzpcbiAgICAgICAgICAgICAgICBwYXRoID0gUGF0aC5qb2luKEFTU0VUU19QQVRILCAnY3NzJywgJ2Fzc2V0cy1nYWxsZXJ5LmNzcycpO1xuICAgICAgICAgICAgICAgIG1pbWUgPSAndGV4dC9jc3MnO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnL2ltYWdlcy9hc3NldHMtbWltZXR5cGVzLnBuZyc6XG4gICAgICAgICAgICAgICAgcGF0aCA9IFBhdGguam9pbihBU1NFVFNfUEFUSCwgJ2ltYWdlcycsICdhc3NldHMtbWltZXR5cGVzLnBuZycpO1xuICAgICAgICAgICAgICAgIG1pbWUgPSAnaW1hZ2UvcG5nJztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJy9pbWFnZXMvYXNzZXRzLW1pbWV0eXBlc0AyeC5wbmcnOlxuICAgICAgICAgICAgICAgIHBhdGggPSBQYXRoLmpvaW4oQVNTRVRTX1BBVEgsICdpbWFnZXMnLCAnYXNzZXRzLW1pbWV0eXBlc0AyeC5wbmcnKTtcbiAgICAgICAgICAgICAgICBtaW1lID0gJ2ltYWdlL3BuZyc7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICcvaW1hZ2VzL2Fzc2V0cy1sb2FkZXIuZ2lmJzpcbiAgICAgICAgICAgICAgICBwYXRoID0gUGF0aC5qb2luKEFTU0VUU19QQVRILCAnaW1hZ2VzJywgJ2Fzc2V0cy1sb2FkZXIuZ2lmJyk7XG4gICAgICAgICAgICAgICAgbWltZSA9ICdpbWFnZS9naWYnO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnL2ltYWdlcy9hc3NldHMtcmVtb3ZlLnBuZyc6XG4gICAgICAgICAgICAgICAgcGF0aCA9IFBhdGguam9pbihBU1NFVFNfUEFUSCwgJ2ltYWdlcycsICdhc3NldHMtcmVtb3ZlLnBuZycpO1xuICAgICAgICAgICAgICAgIG1pbWUgPSAnaW1hZ2UvcG5nJztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcGF0aCA9IFBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLi9yZXNvdXJjZXMvaW5kZXguaHRtbCcpO1xuICAgICAgICAgICAgICAgIG1pbWUgPSAndGV4dC9odG1sJztcbiAgICAgICAgfVxuICAgICAgICBzdGF0cyA9IHlpZWxkIGZzLnN0YXQocGF0aCk7XG4gICAgICAgIHN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0ocGF0aCk7XG4gICAgICAgIHJlcy53cml0ZUhlYWQoMjAwLCB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogbWltZSxcbiAgICAgICAgICAgICdDb250ZW50LUxlbmd0aCc6IHN0YXRzLnNpemUsXG4gICAgICAgIH0pO1xuICAgICAgICBzdHJlYW0ucGlwZShyZXMpO1xuICAgIH0pO1xufVxuIiwiaW1wb3J0IHtwaWNrfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQge0Fzc2V0c30gZnJvbSAnLi4vaW5kZXgnO1xuaW1wb3J0IHtBc3NldHNSb3V0ZXJ9IGZyb20gJy4uL2h0dHAvc2VydmVyJztcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdtei9mcyc7XG5pbXBvcnQgKiBhcyBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgRGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1ZyA9IERlYnVnKCdhc3NldHM6Y2xpOnNlcnZlcicpO1xuXG5cbmNvbnN0IGV0YWcgPSByZXF1aXJlKCdldGFnJyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJ2ZXJDb21tYW5kKHByb2dyYW0pIHtcbiAgICBcbiAgICB2YXIgY21kOiBjb21tYW5kZXIuSUNvbW1hbmQgPSBwcm9ncmFtLmNvbW1hbmQoJ2h0dHAnKVxuICAgIC5hY3Rpb24oZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgb3B0aW9ucyA9IHBpY2soY21kLCBbJ3BvcnQnLCAnd2ViJywgJ2NvbmZpZyddKTtcbiAgICAgICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzdGFydFNlcnZlcihvcHRpb25zKTsgICAgXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdDb3VsZCBub3Qgc3RhcnQgc2VydmVyOiAlcycsIGUubWVzc2FnZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgIH0pO1xuICAgIFxuICAgIGNtZC5vcHRpb24oXCItcCwgLS1wb3J0IDxwb3J0PlwiLCBcInBvcnQgdG8gdXNlIFtkZWZhdWx0OiA1MDAwXVwiLCA1MDAwKVxuICAgIC5vcHRpb24oJy13LCAtLXdlYicsICd3ZWIgY2xpZW50JylcbiAgICAub3B0aW9uKCctYywgLS1jb25maWcgPHBhdGg+Jyk7XG4gICAgXG4gICAgICBcbn1cblxuXG5mdW5jdGlvbiBzdGFydFNlcnZlciAob3B0aW9ucykge1xuICAgIFxuICAgIGxldCBzZXJ2ZXI6IGh0dHAuU2VydmVyO1xuICAgIGxldCByb3V0ZXI6IEFzc2V0c1JvdXRlcjtcbiAgICBcbiAgICBjb25zdCBjbGVhbiA9ICgpID0+IHtcbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoXCJFeGl0aW5nIC4uLiBcIik7XG4gICAgICAgIGlmIChzZXJ2ZXIpIHNlcnZlci5jbG9zZSgpO1xuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnZG9uZVxcbicpO1xuICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgfSBcbiAgICBcbiAgICBsZXQgY29uZmlnID0ge307XG4gICAgaWYgKG9wdGlvbnMuY29uZmlnKSB7XG4gICAgICAgIGxldCBjb25maWdQYXRoID0gb3B0aW9ucy5jb25maWc7IFxuICAgICAgICBpZiAoIVBhdGguaXNBYnNvbHV0ZShjb25maWdQYXRoKSlcbiAgICAgICAgICAgIGNvbmZpZ1BhdGggPSBQYXRoLnJlc29sdmUob3B0aW9ucy5jb25maWcpO1xuICAgICAgICBjb25maWcgPSByZXF1aXJlKGNvbmZpZ1BhdGgpO1xuICAgICAgICBjb25zb2xlLmxvZygnVXNpbmcgY29uZmlnIGZpbGU6ICVzJywgY29uZmlnUGF0aCk7XG4gICAgfVxuICAgIFxuICAgIGxldCBhc3NldHMgPSBuZXcgQXNzZXRzKGNvbmZpZyk7XG4gICAgXG5cbiAgIFxuICAgIGxldCBwcmVmaXggPSBvcHRpb25zLndlYiA/ICcvZmlsZXMnIDogJy8nO1xuICAgIFxuICAgIHJvdXRlciA9IG5ldyBBc3NldHNSb3V0ZXIoYXNzZXRzLCB7XG4gICAgICAgIHByZWZpeDogcHJlZml4XG4gICAgfSk7XG4gICAgXG4gICAgc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgXG4gICAgICAgcm91dGVyLm1pZGRsZXdhcmUocmVxLCByZXMsICgpID0+IHtcbiAgICAgICAgICAgXG4gICAgICAgICAgIGlmIChvcHRpb25zLndlYikge1xuICAgICAgICAgICAgICAgZGVidWcoJ2hhbmRsZSBjbGllbnQnKTtcbiAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVDbGllbnQoYXNzZXRzLCByZXEsIHJlcykuY2F0Y2goIGUgPT4ge1xuICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjayk7XG4gICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKVxuICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgIH1cbiAgICAgICAgICAgXG4gICAgICAgICAgIHJlcy53cml0ZUhlYWQoNDA0KTtcbiAgICAgICAgICAgcmVzLmVuZCgpO1xuICAgICAgICAgICBcbiAgICAgICB9KTtcbiAgICAgICAgXG4gICAgfSk7XG4gICAgXG4gICAgYXNzZXRzLmluaXRpYWxpemUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ1N0YXJ0aW5nIHNlcnZlciBvbiBwb3J0ICVzJywgb3B0aW9ucy5wb3J0KTtcbiAgICAgICAgc2VydmVyLmxpc3RlbihvcHRpb25zLnBvcnQpO1xuICAgIH0pLmNhdGNoKCBlID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3I6ICcsIGUpO1xuICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgIH0pO1xuICAgIFxuICAgIHByb2Nlc3Mub24oJ1NJR0lOVCcsIGNsZWFuKTtcbiAgICBcbiAgICBcbn1cblxuY29uc3QgQVNTRVRTX1BBVEggPSBQYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4nICwnbm9kZV9tb2R1bGVzL2Fzc2V0cy5nYWxsZXJ5L2Rpc3QnKTtcblxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlQ2xpZW50KGFzc2V0czpBc3NldHMsIHJlcTogaHR0cC5JbmNvbWluZ01lc3NhZ2UsIHJlczogaHR0cC5TZXJ2ZXJSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIFxuICAgIGxldCBzdHJlYW0sIG1pbWUgPSBcInRleHQvaHRtbFwiLCBzdGF0cztcbiAgICBsZXQgcGF0aDogc3RyaW5nO1xuICAgIFxuICAgIHN3aXRjaCAocmVxLnVybCkge1xuICAgICAgICBjYXNlICcvanMvYXNzZXRzLWdhbGxlcnkuanMnOlxuICAgICAgICAgICAgcGF0aCA9IFBhdGguam9pbihBU1NFVFNfUEFUSCwgJ2pzJywgJ2Fzc2V0cy1nYWxsZXJ5LmpzJylcbiAgICAgICAgICAgIG1pbWUgPSAnYXBwbGljYXRpb24vamF2YXNjcmlwdCc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnL2Nzcy9hc3NldHMtZ2FsbGVyeS5jc3MnOlxuICAgICAgICAgICAgcGF0aCA9IFBhdGguam9pbihBU1NFVFNfUEFUSCwgJ2NzcycsICdhc3NldHMtZ2FsbGVyeS5jc3MnKTtcbiAgICAgICAgICAgIG1pbWUgPSAndGV4dC9jc3MnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJy9pbWFnZXMvYXNzZXRzLW1pbWV0eXBlcy5wbmcnOlxuICAgICAgICAgICAgcGF0aCA9IFBhdGguam9pbihBU1NFVFNfUEFUSCwgJ2ltYWdlcycsICdhc3NldHMtbWltZXR5cGVzLnBuZycpXG4gICAgICAgICAgICBtaW1lID0gJ2ltYWdlL3BuZyc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnL2ltYWdlcy9hc3NldHMtbWltZXR5cGVzQDJ4LnBuZyc6XG4gICAgICAgICAgICBwYXRoID0gUGF0aC5qb2luKEFTU0VUU19QQVRILCAnaW1hZ2VzJywgJ2Fzc2V0cy1taW1ldHlwZXNAMngucG5nJylcbiAgICAgICAgICAgIG1pbWUgPSAnaW1hZ2UvcG5nJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICcvaW1hZ2VzL2Fzc2V0cy1sb2FkZXIuZ2lmJzpcbiAgICAgICAgICAgIHBhdGggPSBQYXRoLmpvaW4oQVNTRVRTX1BBVEgsICdpbWFnZXMnLCAnYXNzZXRzLWxvYWRlci5naWYnKTtcbiAgICAgICAgICAgIG1pbWUgPSAnaW1hZ2UvZ2lmJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICcvaW1hZ2VzL2Fzc2V0cy1yZW1vdmUucG5nJzpcbiAgICAgICAgICAgIHBhdGggPSBQYXRoLmpvaW4oQVNTRVRTX1BBVEgsICdpbWFnZXMnLCAnYXNzZXRzLXJlbW92ZS5wbmcnKTtcbiAgICAgICAgICAgIG1pbWUgPSAnaW1hZ2UvcG5nJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcGF0aCA9IFBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLi9yZXNvdXJjZXMvaW5kZXguaHRtbCcpO1xuICAgICAgICAgICAgbWltZSA9ICd0ZXh0L2h0bWwnOyAgICAgICBcbiAgICB9XG4gICAgXG4gICAgc3RhdHMgPSBhd2FpdCBmcy5zdGF0KHBhdGgpO1xuICAgIFxuICAgIHN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0ocGF0aCk7XG4gICAgXG4gICAgcmVzLndyaXRlSGVhZCgyMDAsIHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6IG1pbWUsXG4gICAgICAgICdDb250ZW50LUxlbmd0aCc6IHN0YXRzLnNpemUsXG4gICAgICAgIC8vJ0VUYWcnOiBldGFnKHN0YXRzKVxuICAgIH0pO1xuICAgIFxuICAgIHN0cmVhbS5waXBlKHJlcyk7ICAgIFxufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
