"use strict";

var __awaiter = undefined && undefined.__awaiter || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) {
            try {
                step(generator.next(value));
            } catch (e) {
                reject(e);
            }
        }
        function rejected(value) {
            try {
                step(generator.throw(value));
            } catch (e) {
                reject(e);
            }
        }
        function step(result) {
            result.done ? resolve(result.value) : new P(function (resolve) {
                resolve(result.value);
            }).then(fulfilled, rejected);
        }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
var Path = require('path');
var fs = require('mz/fs');
var os = require('os');
var crypto = require('mz/crypto');
var Mime = require('mime-types');
var sanitize = require('sanitize-filename');
function randomName(name) {
    var len = arguments.length <= 1 || arguments[1] === undefined ? 32 : arguments[1];
    var algo = arguments.length <= 2 || arguments[2] === undefined ? 'sha1' : arguments[2];

    return __awaiter(this, void 0, Promise, function* () {
        var rnd = yield crypto.randomBytes(len),
            rndString = crypto.createHash(algo).update(rnd.toString()).digest('hex');
        if (name) rndString += Path.extname(name);
        return rndString;
    });
}
exports.randomName = randomName;
function tmpFile(name) {
    return __awaiter(this, void 0, Promise, function* () {
        var tmpDir = os.tmpdir();
        var rname = yield randomName(name);
        return Path.join(tmpDir, rname);
    });
}
exports.tmpFile = tmpFile;
function getFileStats(path) {
    return fs.stat(path);
}
exports.getFileStats = getFileStats;
function getMimeType(path) {
    var mime = Mime.lookup(path);
    if (mime === false) {
        mime = "application/octet-stream";
    }
    return mime;
}
exports.getMimeType = getMimeType;
function writeStream(stream, path) {
    return new Promise(function (resolve, reject) {
        var ws = fs.createWriteStream(path);
        ws.on('finish', resolve).on('error', reject);
        stream.on('error', reject);
        stream.pipe(ws);
    });
}
exports.writeStream = writeStream;
function pick(obj, args) {
    var out = {};
    for (var i = 0, ii = args.length; i < ii; i++) {
        if (obj[args[i]]) out[args[i]] = obj[args[i]];
    }
    return out;
}
exports.pick = pick;
function normalizePath(path) {
    if (path[path.length - 1] !== '/') path += '/';
    if (path[0] !== '/') path = '/' + path;
    if (path === ".") path = "/";
    return path;
}
exports.normalizePath = normalizePath;
function normalizeFileName(filename) {
    filename = sanitize(filename.replace(/[^a-z0-9\-\.]/gi, '_'));
    if (filename[0] === '/') filename = filename.substr(1);
    return filename;
}
exports.normalizeFileName = normalizeFileName;
function writeFile(stream, path) {
    return new Promise(function (resolve, reject) {
        var ws = fs.createWriteStream(path);
        ws.on('finish', resolve).on('error', reject);
        stream.on('error', reject);
        stream.pipe(ws);
    });
}
exports.writeFile = writeFile;
function writeToTempFile(stream, path) {
    return __awaiter(this, void 0, Promise, function* () {
        var rnd = yield randomName(path);
        var tmpFile = Path.join(os.tmpdir(), rnd);
        yield writeFile(stream, tmpFile);
        return tmpFile;
    });
}
exports.writeToTempFile = writeToTempFile;
//# sourceMappingURL=data:application/json;base64,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QUFMLEVBQVEsT0FBeEIsRUFBaUMsYUFBYTtBQ1RyRCxZQUFJLE1BQU0sTUFBTSxXQUFXLElBQVgsQ0FBTixDRFMyQztBQ1JyRCxZQUFJLFVBQVUsS0FBSyxJQUFMLENBQVUsR0FBRyxNQUFILEVBQVYsRUFBdUIsR0FBdkIsQ0FBVixDRFFpRDtBQ1ByRCxjQUFNLFVBQVUsTUFBVixFQUFrQixPQUFsQixDQUFOLENET3FEO0FDTnJELGVBQU8sT0FBUCxDRE1xRDtLQUFiLENBQXhDLENDVmdFO0NBQXBFO0FBQXNCLFFBQUEsZUFBQSxHQUFlLGVBQWYiLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLnRocm93KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMpKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbmNvbnN0IFBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBmcyA9IHJlcXVpcmUoJ216L2ZzJyk7XG5jb25zdCBvcyA9IHJlcXVpcmUoJ29zJyk7XG5jb25zdCBjcnlwdG8gPSByZXF1aXJlKCdtei9jcnlwdG8nKTtcbmNvbnN0IE1pbWUgPSByZXF1aXJlKCdtaW1lLXR5cGVzJyk7XG5jb25zdCBzYW5pdGl6ZSA9IHJlcXVpcmUoJ3Nhbml0aXplLWZpbGVuYW1lJyk7XG5mdW5jdGlvbiByYW5kb21OYW1lKG5hbWUsIGxlbiA9IDMyLCBhbGdvID0gJ3NoYTEnKSB7XG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIFByb21pc2UsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgIGxldCBybmQgPSB5aWVsZCBjcnlwdG8ucmFuZG9tQnl0ZXMobGVuKSwgcm5kU3RyaW5nID0gY3J5cHRvLmNyZWF0ZUhhc2goYWxnbykudXBkYXRlKHJuZC50b1N0cmluZygpKS5kaWdlc3QoJ2hleCcpO1xuICAgICAgICBpZiAobmFtZSlcbiAgICAgICAgICAgIHJuZFN0cmluZyArPSBQYXRoLmV4dG5hbWUobmFtZSk7XG4gICAgICAgIHJldHVybiBybmRTdHJpbmc7XG4gICAgfSk7XG59XG5leHBvcnRzLnJhbmRvbU5hbWUgPSByYW5kb21OYW1lO1xuZnVuY3Rpb24gdG1wRmlsZShuYW1lKSB7XG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIFByb21pc2UsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgIGxldCB0bXBEaXIgPSBvcy50bXBkaXIoKTtcbiAgICAgICAgbGV0IHJuYW1lID0geWllbGQgcmFuZG9tTmFtZShuYW1lKTtcbiAgICAgICAgcmV0dXJuIFBhdGguam9pbih0bXBEaXIsIHJuYW1lKTtcbiAgICB9KTtcbn1cbmV4cG9ydHMudG1wRmlsZSA9IHRtcEZpbGU7XG5mdW5jdGlvbiBnZXRGaWxlU3RhdHMocGF0aCkge1xuICAgIHJldHVybiBmcy5zdGF0KHBhdGgpO1xufVxuZXhwb3J0cy5nZXRGaWxlU3RhdHMgPSBnZXRGaWxlU3RhdHM7XG5mdW5jdGlvbiBnZXRNaW1lVHlwZShwYXRoKSB7XG4gICAgbGV0IG1pbWUgPSBNaW1lLmxvb2t1cChwYXRoKTtcbiAgICBpZiAobWltZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgbWltZSA9IFwiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtXCI7XG4gICAgfVxuICAgIHJldHVybiBtaW1lO1xufVxuZXhwb3J0cy5nZXRNaW1lVHlwZSA9IGdldE1pbWVUeXBlO1xuZnVuY3Rpb24gd3JpdGVTdHJlYW0oc3RyZWFtLCBwYXRoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdmFyIHdzID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0ocGF0aCk7XG4gICAgICAgIHdzLm9uKCdmaW5pc2gnLCByZXNvbHZlKVxuICAgICAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzdHJlYW0ucGlwZSh3cyk7XG4gICAgfSk7XG59XG5leHBvcnRzLndyaXRlU3RyZWFtID0gd3JpdGVTdHJlYW07XG5mdW5jdGlvbiBwaWNrKG9iaiwgYXJncykge1xuICAgIGxldCBvdXQgPSB7fTtcbiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBhcmdzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHtcbiAgICAgICAgaWYgKG9ialthcmdzW2ldXSlcbiAgICAgICAgICAgIG91dFthcmdzW2ldXSA9IG9ialthcmdzW2ldXTtcbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbn1cbmV4cG9ydHMucGljayA9IHBpY2s7XG5mdW5jdGlvbiBub3JtYWxpemVQYXRoKHBhdGgpIHtcbiAgICBpZiAocGF0aFtwYXRoLmxlbmd0aCAtIDFdICE9PSAnLycpXG4gICAgICAgIHBhdGggKz0gJy8nO1xuICAgIGlmIChwYXRoWzBdICE9PSAnLycpXG4gICAgICAgIHBhdGggPSAnLycgKyBwYXRoO1xuICAgIGlmIChwYXRoID09PSBcIi5cIilcbiAgICAgICAgcGF0aCA9IFwiL1wiO1xuICAgIHJldHVybiBwYXRoO1xufVxuZXhwb3J0cy5ub3JtYWxpemVQYXRoID0gbm9ybWFsaXplUGF0aDtcbmZ1bmN0aW9uIG5vcm1hbGl6ZUZpbGVOYW1lKGZpbGVuYW1lKSB7XG4gICAgZmlsZW5hbWUgPSBzYW5pdGl6ZShmaWxlbmFtZS5yZXBsYWNlKC9bXmEtejAtOVxcLVxcLl0vZ2ksICdfJykpO1xuICAgIGlmIChmaWxlbmFtZVswXSA9PT0gJy8nKVxuICAgICAgICBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cigxKTtcbiAgICByZXR1cm4gZmlsZW5hbWU7XG59XG5leHBvcnRzLm5vcm1hbGl6ZUZpbGVOYW1lID0gbm9ybWFsaXplRmlsZU5hbWU7XG5mdW5jdGlvbiB3cml0ZUZpbGUoc3RyZWFtLCBwYXRoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdmFyIHdzID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0ocGF0aCk7XG4gICAgICAgIHdzLm9uKCdmaW5pc2gnLCByZXNvbHZlKVxuICAgICAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzdHJlYW0ucGlwZSh3cyk7XG4gICAgfSk7XG59XG5leHBvcnRzLndyaXRlRmlsZSA9IHdyaXRlRmlsZTtcbmZ1bmN0aW9uIHdyaXRlVG9UZW1wRmlsZShzdHJlYW0sIHBhdGgpIHtcbiAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgUHJvbWlzZSwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgbGV0IHJuZCA9IHlpZWxkIHJhbmRvbU5hbWUocGF0aCk7XG4gICAgICAgIGxldCB0bXBGaWxlID0gUGF0aC5qb2luKG9zLnRtcGRpcigpLCBybmQpO1xuICAgICAgICB5aWVsZCB3cml0ZUZpbGUoc3RyZWFtLCB0bXBGaWxlKTtcbiAgICAgICAgcmV0dXJuIHRtcEZpbGU7XG4gICAgfSk7XG59XG5leHBvcnRzLndyaXRlVG9UZW1wRmlsZSA9IHdyaXRlVG9UZW1wRmlsZTtcbiIsImltcG9ydCAqIGFzIFBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdtei9mcyc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQge1JlYWRhYmxlfSBmcm9tICdzdHJlYW0nO1xuXG5jb25zdCBjcnlwdG8gPSByZXF1aXJlKCdtei9jcnlwdG8nKTtcbmNvbnN0IE1pbWUgPSByZXF1aXJlKCdtaW1lLXR5cGVzJyk7XG5jb25zdCBzYW5pdGl6ZSA9IHJlcXVpcmUoJ3Nhbml0aXplLWZpbGVuYW1lJyk7XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJhbmRvbU5hbWUobmFtZT86IHN0cmluZywgbGVuOiBudW1iZXIgPSAzMiwgYWxnbzogc3RyaW5nID0gJ3NoYTEnKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBsZXQgcm5kID0gYXdhaXQgY3J5cHRvLnJhbmRvbUJ5dGVzKGxlbiksXG4gICAgICAgIHJuZFN0cmluZzogc3RyaW5nID0gY3J5cHRvLmNyZWF0ZUhhc2goYWxnbykudXBkYXRlKHJuZC50b1N0cmluZygpKS5kaWdlc3QoJ2hleCcpO1xuXG4gICAgaWYgKG5hbWUpIHJuZFN0cmluZyArPSBQYXRoLmV4dG5hbWUobmFtZSk7XG5cbiAgICByZXR1cm4gcm5kU3RyaW5nO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdG1wRmlsZShuYW1lPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBsZXQgdG1wRGlyID0gb3MudG1wZGlyKCk7XG4gICAgbGV0IHJuYW1lID0gYXdhaXQgcmFuZG9tTmFtZShuYW1lKTtcblxuICAgIHJldHVybiBQYXRoLmpvaW4odG1wRGlyLCBybmFtZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGaWxlU3RhdHMocGF0aDogc3RyaW5nKTogUHJvbWlzZTxmcy5TdGF0cz4ge1xuICAgIHJldHVybiBmcy5zdGF0KHBhdGgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWltZVR5cGUocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBsZXQgbWltZSA9IE1pbWUubG9va3VwKHBhdGgpO1xuICAgIGlmIChtaW1lID09PSBmYWxzZSkge1xuICAgICAgICBtaW1lID0gXCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIjtcbiAgICB9XG4gICAgcmV0dXJuIG1pbWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cml0ZVN0cmVhbShzdHJlYW06IFJlYWRhYmxlLCBwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHZhciB3cyA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGgpO1xuICAgICAgICB3cy5vbignZmluaXNoJywgcmVzb2x2ZSlcbiAgICAgICAgICAgIC5vbignZXJyb3InLCByZWplY3QpO1xuXG4gICAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzdHJlYW0ucGlwZSh3cyk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwaWNrKG9iajogYW55LCBhcmdzOiBzdHJpbmdbXSk6IGFueSB7XG4gICAgbGV0IG91dCA9IHt9O1xuICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGFyZ3MubGVuZ3RoOyBpIDwgaWk7IGkrKykge1xuICAgICAgICBpZiAob2JqW2FyZ3NbaV1dKSBvdXRbYXJnc1tpXV0gPSBvYmpbYXJnc1tpXV07XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVQYXRoKHBhdGg6IHN0cmluZykge1xuICAgIGlmIChwYXRoW3BhdGgubGVuZ3RoIC0gMV0gIT09ICcvJykgcGF0aCArPSAnLyc7XG4gICAgaWYgKHBhdGhbMF0gIT09ICcvJykgcGF0aCA9ICcvJyArIHBhdGg7XG4gICAgaWYgKHBhdGggPT09IFwiLlwiKSBwYXRoID0gXCIvXCI7XG4gICAgcmV0dXJuIHBhdGg7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVGaWxlTmFtZShmaWxlbmFtZTogc3RyaW5nKSB7XG4gICAgZmlsZW5hbWUgPSBzYW5pdGl6ZShmaWxlbmFtZS5yZXBsYWNlKC9bXmEtejAtOVxcLVxcLl0vZ2ksICdfJykpO1xuICAgIGlmIChmaWxlbmFtZVswXSA9PT0gJy8nKSBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cigxKTtcbiAgICByZXR1cm4gZmlsZW5hbWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cml0ZUZpbGUoc3RyZWFtOiBSZWFkYWJsZSwgcGF0aDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICB2YXIgd3MgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShwYXRoKTtcbiAgICAgICAgd3Mub24oJ2ZpbmlzaCcsIHJlc29sdmUpXG4gICAgICAgIC5vbignZXJyb3InLCByZWplY3QpO1xuXG4gICAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzdHJlYW0ucGlwZSh3cyk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3cml0ZVRvVGVtcEZpbGUoc3RyZWFtOiBSZWFkYWJsZSwgcGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBsZXQgcm5kID0gYXdhaXQgcmFuZG9tTmFtZShwYXRoKTtcbiAgICBsZXQgdG1wRmlsZSA9IFBhdGguam9pbihvcy50bXBkaXIoKSwgcm5kKTtcbiAgICBhd2FpdCB3cml0ZUZpbGUoc3RyZWFtLCB0bXBGaWxlKTtcbiAgICByZXR1cm4gdG1wRmlsZTtcbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
