"use strict";

var __awaiter = undefined && undefined.__awaiter || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) {
            try {
                step(generator.next(value));
            } catch (e) {
                reject(e);
            }
        }
        function rejected(value) {
            try {
                step(generator.throw(value));
            } catch (e) {
                reject(e);
            }
        }
        function step(result) {
            result.done ? resolve(result.value) : new P(function (resolve) {
                resolve(result.value);
            }).then(fulfilled, rejected);
        }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
var Path = require('path');
var fs = require('mz/fs');
var os = require('os');
var crypto = require('mz/crypto');
var Mime = require('mime-types');
function randomName(name) {
    var len = arguments.length <= 1 || arguments[1] === undefined ? 32 : arguments[1];
    var algo = arguments.length <= 2 || arguments[2] === undefined ? 'sha1' : arguments[2];

    return __awaiter(this, void 0, Promise, function* () {
        var rnd = yield crypto.randomBytes(len),
            rndString = crypto.createHash(algo).update(rnd.toString()).digest('hex');
        if (name) rndString += Path.extname(name);
        return rndString;
    });
}
exports.randomName = randomName;
function tmpFile(name) {
    return __awaiter(this, void 0, Promise, function* () {
        var tmpDir = os.tmpdir();
        var rname = yield randomName(name);
        return Path.join(tmpDir, rname);
    });
}
exports.tmpFile = tmpFile;
function getFileStats(path) {
    return fs.stat(path);
}
exports.getFileStats = getFileStats;
function getMimeType(path) {
    var mime = Mime.lookup(path);
    console.log('MIME', mime, path);
    if (mime === false) {
        mime = "application/octet-stream";
    }
    return mime;
}
exports.getMimeType = getMimeType;
function writeStream(stream, path) {
    return new Promise(function (resolve, reject) {
        var ws = fs.createWriteStream(path);
        ws.on('finish', resolve).on('error', reject);
        stream.on('error', reject);
        stream.pipe(ws);
    });
}
exports.writeStream = writeStream;
function pick(obj, args) {
    var out = {};
    for (var i = 0, ii = args.length; i < ii; i++) {
        if (obj[args[i]]) out[args[i]] = obj[args[i]];
    }
    return out;
}
exports.pick = pick;
//# sourceMappingURL=data:application/json;base64,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aWxlIjoidXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLnRocm93KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMpKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbmNvbnN0IFBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBmcyA9IHJlcXVpcmUoJ216L2ZzJyk7XG5jb25zdCBvcyA9IHJlcXVpcmUoJ29zJyk7XG5jb25zdCBjcnlwdG8gPSByZXF1aXJlKCdtei9jcnlwdG8nKTtcbmNvbnN0IE1pbWUgPSByZXF1aXJlKCdtaW1lLXR5cGVzJyk7XG5mdW5jdGlvbiByYW5kb21OYW1lKG5hbWUsIGxlbiA9IDMyLCBhbGdvID0gJ3NoYTEnKSB7XG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIFByb21pc2UsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgIGxldCBybmQgPSB5aWVsZCBjcnlwdG8ucmFuZG9tQnl0ZXMobGVuKSwgcm5kU3RyaW5nID0gY3J5cHRvLmNyZWF0ZUhhc2goYWxnbykudXBkYXRlKHJuZC50b1N0cmluZygpKS5kaWdlc3QoJ2hleCcpO1xuICAgICAgICBpZiAobmFtZSlcbiAgICAgICAgICAgIHJuZFN0cmluZyArPSBQYXRoLmV4dG5hbWUobmFtZSk7XG4gICAgICAgIHJldHVybiBybmRTdHJpbmc7XG4gICAgfSk7XG59XG5leHBvcnRzLnJhbmRvbU5hbWUgPSByYW5kb21OYW1lO1xuZnVuY3Rpb24gdG1wRmlsZShuYW1lKSB7XG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIFByb21pc2UsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgIGxldCB0bXBEaXIgPSBvcy50bXBkaXIoKTtcbiAgICAgICAgbGV0IHJuYW1lID0geWllbGQgcmFuZG9tTmFtZShuYW1lKTtcbiAgICAgICAgcmV0dXJuIFBhdGguam9pbih0bXBEaXIsIHJuYW1lKTtcbiAgICB9KTtcbn1cbmV4cG9ydHMudG1wRmlsZSA9IHRtcEZpbGU7XG5mdW5jdGlvbiBnZXRGaWxlU3RhdHMocGF0aCkge1xuICAgIHJldHVybiBmcy5zdGF0KHBhdGgpO1xufVxuZXhwb3J0cy5nZXRGaWxlU3RhdHMgPSBnZXRGaWxlU3RhdHM7XG5mdW5jdGlvbiBnZXRNaW1lVHlwZShwYXRoKSB7XG4gICAgbGV0IG1pbWUgPSBNaW1lLmxvb2t1cChwYXRoKTtcbiAgICBjb25zb2xlLmxvZygnTUlNRScsIG1pbWUsIHBhdGgpO1xuICAgIGlmIChtaW1lID09PSBmYWxzZSkge1xuICAgICAgICBtaW1lID0gXCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIjtcbiAgICB9XG4gICAgcmV0dXJuIG1pbWU7XG59XG5leHBvcnRzLmdldE1pbWVUeXBlID0gZ2V0TWltZVR5cGU7XG5mdW5jdGlvbiB3cml0ZVN0cmVhbShzdHJlYW0sIHBhdGgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICB2YXIgd3MgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShwYXRoKTtcbiAgICAgICAgd3Mub24oJ2ZpbmlzaCcsIHJlc29sdmUpXG4gICAgICAgICAgICAub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICAgIHN0cmVhbS5waXBlKHdzKTtcbiAgICB9KTtcbn1cbmV4cG9ydHMud3JpdGVTdHJlYW0gPSB3cml0ZVN0cmVhbTtcbmZ1bmN0aW9uIHBpY2sob2JqLCBhcmdzKSB7XG4gICAgbGV0IG91dCA9IHt9O1xuICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGFyZ3MubGVuZ3RoOyBpIDwgaWk7IGkrKykge1xuICAgICAgICBpZiAob2JqW2FyZ3NbaV1dKVxuICAgICAgICAgICAgb3V0W2FyZ3NbaV1dID0gb2JqW2FyZ3NbaV1dO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xufVxuZXhwb3J0cy5waWNrID0gcGljaztcbiIsImltcG9ydCAqIGFzIFBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdtei9mcyc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQge1JlYWRhYmxlfSBmcm9tICdzdHJlYW0nO1xuXG5jb25zdCBjcnlwdG8gPSByZXF1aXJlKCdtei9jcnlwdG8nKTtcbmNvbnN0IE1pbWUgPSByZXF1aXJlKCdtaW1lLXR5cGVzJyk7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByYW5kb21OYW1lKG5hbWU/OiBzdHJpbmcsIGxlbjogbnVtYmVyID0gMzIsIGFsZ286IHN0cmluZyA9ICdzaGExJyk6IFByb21pc2U8c3RyaW5nPiB7XG5cbiAgICBsZXQgcm5kID0gYXdhaXQgY3J5cHRvLnJhbmRvbUJ5dGVzKGxlbiksXG4gICAgICAgIHJuZFN0cmluZzogc3RyaW5nID0gY3J5cHRvLmNyZWF0ZUhhc2goYWxnbykudXBkYXRlKHJuZC50b1N0cmluZygpKS5kaWdlc3QoJ2hleCcpO1xuXG4gICAgaWYgKG5hbWUpIHJuZFN0cmluZyArPSBQYXRoLmV4dG5hbWUobmFtZSk7XG5cbiAgICByZXR1cm4gcm5kU3RyaW5nO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdG1wRmlsZShuYW1lPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBsZXQgdG1wRGlyID0gb3MudG1wZGlyKCk7XG4gICAgbGV0IHJuYW1lID0gYXdhaXQgcmFuZG9tTmFtZShuYW1lKTtcbiAgICBcbiAgICByZXR1cm4gUGF0aC5qb2luKHRtcERpciwgcm5hbWUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RmlsZVN0YXRzKHBhdGg6IHN0cmluZyk6IFByb21pc2U8ZnMuU3RhdHM+IHtcbiAgICByZXR1cm4gZnMuc3RhdChwYXRoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1pbWVUeXBlKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgbGV0IG1pbWUgPSAgTWltZS5sb29rdXAocGF0aCk7XG4gICAgY29uc29sZS5sb2coJ01JTUUnLCBtaW1lLCBwYXRoKVxuICAgIGlmIChtaW1lID09PSBmYWxzZSkge1xuICAgICAgICBtaW1lID0gXCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIjtcbiAgICB9XG4gICAgcmV0dXJuIG1pbWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cml0ZVN0cmVhbShzdHJlYW06UmVhZGFibGUsIHBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPihmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdmFyIHdzID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0ocGF0aCk7XG4gICAgICAgIHdzLm9uKCdmaW5pc2gnLCByZXNvbHZlKVxuICAgICAgICAub24oJ2Vycm9yJywgcmVqZWN0KTtcblxuICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgc3RyZWFtLnBpcGUod3MpO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGljayhvYmo6IGFueSwgYXJnczpzdHJpbmdbXSk6IGFueSB7XG4gICAgbGV0IG91dCA9IHt9O1xuICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGFyZ3MubGVuZ3RoOyBpIDwgaWk7IGkrKyApIHtcbiAgICAgICAgaWYgKG9ialthcmdzW2ldXSkgb3V0W2FyZ3NbaV1dID0gb2JqW2FyZ3NbaV1dO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
