"use strict";

var __awaiter = undefined && undefined.__awaiter || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) {
            try {
                step(generator.next(value));
            } catch (e) {
                reject(e);
            }
        }
        function rejected(value) {
            try {
                step(generator.throw(value));
            } catch (e) {
                reject(e);
            }
        }
        function step(result) {
            result.done ? resolve(result.value) : new P(function (resolve) {
                resolve(result.value);
            }).then(fulfilled, rejected);
        }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
var Path = require('path');
var fs = require('mz/fs');
var os = require('os');
var crypto = require('mz/crypto');
var Mime = require('mime-types');
var sanitize = require('sanitize-filename');
function randomName(name) {
    var len = arguments.length <= 1 || arguments[1] === undefined ? 32 : arguments[1];
    var algo = arguments.length <= 2 || arguments[2] === undefined ? 'sha1' : arguments[2];

    return __awaiter(this, void 0, Promise, function* () {
        var rnd = yield crypto.randomBytes(len),
            rndString = crypto.createHash(algo).update(rnd.toString()).digest('hex');
        if (name) rndString += Path.extname(name);
        return rndString;
    });
}
exports.randomName = randomName;
function tmpFile(name) {
    return __awaiter(this, void 0, Promise, function* () {
        var tmpDir = os.tmpdir();
        var rname = yield randomName(name);
        return Path.join(tmpDir, rname);
    });
}
exports.tmpFile = tmpFile;
function getFileStats(path) {
    return fs.stat(path);
}
exports.getFileStats = getFileStats;
function getMimeType(path) {
    var mime = Mime.lookup(path);
    if (mime === false) {
        mime = "application/octet-stream";
    }
    return mime;
}
exports.getMimeType = getMimeType;
function writeStream(stream, path) {
    return new Promise(function (resolve, reject) {
        var ws = fs.createWriteStream(path);
        ws.on('finish', resolve).on('error', reject);
        stream.on('error', reject);
        stream.pipe(ws);
    });
}
exports.writeStream = writeStream;
function pick(obj, args) {
    var out = {};
    for (var i = 0, ii = args.length; i < ii; i++) {
        if (obj[args[i]]) out[args[i]] = obj[args[i]];
    }
    return out;
}
exports.pick = pick;
function normalizePath(path) {
    if (path[path.length - 1] !== '/') path += '/';
    if (path[0] !== '/') path = '/' + path;
    return path;
}
exports.normalizePath = normalizePath;
function normalizeFileName(filename) {
    filename = sanitize(filename.replace(/[^a-z0-9\-\.]/gi, '_'));
    if (filename[0] === '/') filename = filename.substr(1);
    return filename;
}
exports.normalizeFileName = normalizeFileName;
function writeFile(stream, path) {
    return new Promise(function (resolve, reject) {
        var ws = fs.createWriteStream(path);
        ws.on('finish', resolve).on('error', reject);
        stream.on('error', reject);
        stream.pipe(ws);
    });
}
exports.writeFile = writeFile;
function createTemp(stream, path) {
    return __awaiter(this, void 0, Promise, function* () {
        var rnd = yield randomName(path);
        var tmpFile = Path.join(os.tmpdir(), rnd);
        yield writeFile(stream, tmpFile);
        return tmpFile;
    });
}
exports.createTemp = createTemp;
//# sourceMappingURL=data:application/json;base64,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LE1BQU0sV0FBVyxJQUFYLENBQU4sQ0RPMkM7QUNOckQsWUFBSSxVQUFVLEtBQUssSUFBTCxDQUFVLEdBQUcsTUFBSCxFQUFWLEVBQXVCLEdBQXZCLENBQVYsQ0RNaUQ7QUNMckQsY0FBTSxVQUFVLE1BQVYsRUFBa0IsT0FBbEIsQ0FBTixDREtxRDtBQ0pyRCxlQUFPLE9BQVAsQ0RJcUQ7S0FBYixDQUF4QyxDQ1IyRDtDQUEvRDtBQUFzQixRQUFBLFVBQUEsR0FBVSxVQUFWIiwiZmlsZSI6InV0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci50aHJvdyh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5jb25zdCBQYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgZnMgPSByZXF1aXJlKCdtei9mcycpO1xuY29uc3Qgb3MgPSByZXF1aXJlKCdvcycpO1xuY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnbXovY3J5cHRvJyk7XG5jb25zdCBNaW1lID0gcmVxdWlyZSgnbWltZS10eXBlcycpO1xuY29uc3Qgc2FuaXRpemUgPSByZXF1aXJlKCdzYW5pdGl6ZS1maWxlbmFtZScpO1xuZnVuY3Rpb24gcmFuZG9tTmFtZShuYW1lLCBsZW4gPSAzMiwgYWxnbyA9ICdzaGExJykge1xuICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCBQcm9taXNlLCBmdW5jdGlvbiogKCkge1xuICAgICAgICBsZXQgcm5kID0geWllbGQgY3J5cHRvLnJhbmRvbUJ5dGVzKGxlbiksIHJuZFN0cmluZyA9IGNyeXB0by5jcmVhdGVIYXNoKGFsZ28pLnVwZGF0ZShybmQudG9TdHJpbmcoKSkuZGlnZXN0KCdoZXgnKTtcbiAgICAgICAgaWYgKG5hbWUpXG4gICAgICAgICAgICBybmRTdHJpbmcgKz0gUGF0aC5leHRuYW1lKG5hbWUpO1xuICAgICAgICByZXR1cm4gcm5kU3RyaW5nO1xuICAgIH0pO1xufVxuZXhwb3J0cy5yYW5kb21OYW1lID0gcmFuZG9tTmFtZTtcbmZ1bmN0aW9uIHRtcEZpbGUobmFtZSkge1xuICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCBQcm9taXNlLCBmdW5jdGlvbiogKCkge1xuICAgICAgICBsZXQgdG1wRGlyID0gb3MudG1wZGlyKCk7XG4gICAgICAgIGxldCBybmFtZSA9IHlpZWxkIHJhbmRvbU5hbWUobmFtZSk7XG4gICAgICAgIHJldHVybiBQYXRoLmpvaW4odG1wRGlyLCBybmFtZSk7XG4gICAgfSk7XG59XG5leHBvcnRzLnRtcEZpbGUgPSB0bXBGaWxlO1xuZnVuY3Rpb24gZ2V0RmlsZVN0YXRzKHBhdGgpIHtcbiAgICByZXR1cm4gZnMuc3RhdChwYXRoKTtcbn1cbmV4cG9ydHMuZ2V0RmlsZVN0YXRzID0gZ2V0RmlsZVN0YXRzO1xuZnVuY3Rpb24gZ2V0TWltZVR5cGUocGF0aCkge1xuICAgIGxldCBtaW1lID0gTWltZS5sb29rdXAocGF0aCk7XG4gICAgaWYgKG1pbWUgPT09IGZhbHNlKSB7XG4gICAgICAgIG1pbWUgPSBcImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbVwiO1xuICAgIH1cbiAgICByZXR1cm4gbWltZTtcbn1cbmV4cG9ydHMuZ2V0TWltZVR5cGUgPSBnZXRNaW1lVHlwZTtcbmZ1bmN0aW9uIHdyaXRlU3RyZWFtKHN0cmVhbSwgcGF0aCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHZhciB3cyA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGgpO1xuICAgICAgICB3cy5vbignZmluaXNoJywgcmVzb2x2ZSlcbiAgICAgICAgICAgIC5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgc3RyZWFtLnBpcGUod3MpO1xuICAgIH0pO1xufVxuZXhwb3J0cy53cml0ZVN0cmVhbSA9IHdyaXRlU3RyZWFtO1xuZnVuY3Rpb24gcGljayhvYmosIGFyZ3MpIHtcbiAgICBsZXQgb3V0ID0ge307XG4gICAgZm9yIChsZXQgaSA9IDAsIGlpID0gYXJncy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7XG4gICAgICAgIGlmIChvYmpbYXJnc1tpXV0pXG4gICAgICAgICAgICBvdXRbYXJnc1tpXV0gPSBvYmpbYXJnc1tpXV07XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG59XG5leHBvcnRzLnBpY2sgPSBwaWNrO1xuZnVuY3Rpb24gbm9ybWFsaXplUGF0aChwYXRoKSB7XG4gICAgaWYgKHBhdGhbcGF0aC5sZW5ndGggLSAxXSAhPT0gJy8nKVxuICAgICAgICBwYXRoICs9ICcvJztcbiAgICBpZiAocGF0aFswXSAhPT0gJy8nKVxuICAgICAgICBwYXRoID0gJy8nICsgcGF0aDtcbiAgICByZXR1cm4gcGF0aDtcbn1cbmV4cG9ydHMubm9ybWFsaXplUGF0aCA9IG5vcm1hbGl6ZVBhdGg7XG5mdW5jdGlvbiBub3JtYWxpemVGaWxlTmFtZShmaWxlbmFtZSkge1xuICAgIGZpbGVuYW1lID0gc2FuaXRpemUoZmlsZW5hbWUucmVwbGFjZSgvW15hLXowLTlcXC1cXC5dL2dpLCAnXycpKTtcbiAgICBpZiAoZmlsZW5hbWVbMF0gPT09ICcvJylcbiAgICAgICAgZmlsZW5hbWUgPSBmaWxlbmFtZS5zdWJzdHIoMSk7XG4gICAgcmV0dXJuIGZpbGVuYW1lO1xufVxuZXhwb3J0cy5ub3JtYWxpemVGaWxlTmFtZSA9IG5vcm1hbGl6ZUZpbGVOYW1lO1xuZnVuY3Rpb24gd3JpdGVGaWxlKHN0cmVhbSwgcGF0aCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHZhciB3cyA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGgpO1xuICAgICAgICB3cy5vbignZmluaXNoJywgcmVzb2x2ZSlcbiAgICAgICAgICAgIC5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgc3RyZWFtLnBpcGUod3MpO1xuICAgIH0pO1xufVxuZXhwb3J0cy53cml0ZUZpbGUgPSB3cml0ZUZpbGU7XG5mdW5jdGlvbiBjcmVhdGVUZW1wKHN0cmVhbSwgcGF0aCkge1xuICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCBQcm9taXNlLCBmdW5jdGlvbiogKCkge1xuICAgICAgICBsZXQgcm5kID0geWllbGQgcmFuZG9tTmFtZShwYXRoKTtcbiAgICAgICAgbGV0IHRtcEZpbGUgPSBQYXRoLmpvaW4ob3MudG1wZGlyKCksIHJuZCk7XG4gICAgICAgIHlpZWxkIHdyaXRlRmlsZShzdHJlYW0sIHRtcEZpbGUpO1xuICAgICAgICByZXR1cm4gdG1wRmlsZTtcbiAgICB9KTtcbn1cbmV4cG9ydHMuY3JlYXRlVGVtcCA9IGNyZWF0ZVRlbXA7XG4iLCJpbXBvcnQgKiBhcyBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnbXovZnMnO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHtSZWFkYWJsZX0gZnJvbSAnc3RyZWFtJztcblxuY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnbXovY3J5cHRvJyk7XG5jb25zdCBNaW1lID0gcmVxdWlyZSgnbWltZS10eXBlcycpO1xuY29uc3Qgc2FuaXRpemUgPSByZXF1aXJlKCdzYW5pdGl6ZS1maWxlbmFtZScpO1xuXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByYW5kb21OYW1lKG5hbWU/OiBzdHJpbmcsIGxlbjogbnVtYmVyID0gMzIsIGFsZ286IHN0cmluZyA9ICdzaGExJyk6IFByb21pc2U8c3RyaW5nPiB7XG5cbiAgICBsZXQgcm5kID0gYXdhaXQgY3J5cHRvLnJhbmRvbUJ5dGVzKGxlbiksXG4gICAgICAgIHJuZFN0cmluZzogc3RyaW5nID0gY3J5cHRvLmNyZWF0ZUhhc2goYWxnbykudXBkYXRlKHJuZC50b1N0cmluZygpKS5kaWdlc3QoJ2hleCcpO1xuXG4gICAgaWYgKG5hbWUpIHJuZFN0cmluZyArPSBQYXRoLmV4dG5hbWUobmFtZSk7XG5cbiAgICByZXR1cm4gcm5kU3RyaW5nO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdG1wRmlsZShuYW1lPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBsZXQgdG1wRGlyID0gb3MudG1wZGlyKCk7XG4gICAgbGV0IHJuYW1lID0gYXdhaXQgcmFuZG9tTmFtZShuYW1lKTtcblxuICAgIHJldHVybiBQYXRoLmpvaW4odG1wRGlyLCBybmFtZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGaWxlU3RhdHMocGF0aDogc3RyaW5nKTogUHJvbWlzZTxmcy5TdGF0cz4ge1xuICAgIHJldHVybiBmcy5zdGF0KHBhdGgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWltZVR5cGUocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBsZXQgbWltZSA9IE1pbWUubG9va3VwKHBhdGgpO1xuICAgIGlmIChtaW1lID09PSBmYWxzZSkge1xuICAgICAgICBtaW1lID0gXCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIjtcbiAgICB9XG4gICAgcmV0dXJuIG1pbWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cml0ZVN0cmVhbShzdHJlYW06IFJlYWRhYmxlLCBwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHZhciB3cyA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHBhdGgpO1xuICAgICAgICB3cy5vbignZmluaXNoJywgcmVzb2x2ZSlcbiAgICAgICAgICAgIC5vbignZXJyb3InLCByZWplY3QpO1xuXG4gICAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzdHJlYW0ucGlwZSh3cyk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwaWNrKG9iajogYW55LCBhcmdzOiBzdHJpbmdbXSk6IGFueSB7XG4gICAgbGV0IG91dCA9IHt9O1xuICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGFyZ3MubGVuZ3RoOyBpIDwgaWk7IGkrKykge1xuICAgICAgICBpZiAob2JqW2FyZ3NbaV1dKSBvdXRbYXJnc1tpXV0gPSBvYmpbYXJnc1tpXV07XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVQYXRoKHBhdGg6IHN0cmluZykge1xuICAgIGlmIChwYXRoW3BhdGgubGVuZ3RoIC0gMV0gIT09ICcvJykgcGF0aCArPSAnLyc7XG4gICAgaWYgKHBhdGhbMF0gIT09ICcvJykgcGF0aCA9ICcvJyArIHBhdGg7XG4gICAgcmV0dXJuIHBhdGg7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVGaWxlTmFtZShmaWxlbmFtZTogc3RyaW5nKSB7XG4gICAgZmlsZW5hbWUgPSBzYW5pdGl6ZShmaWxlbmFtZS5yZXBsYWNlKC9bXmEtejAtOVxcLVxcLl0vZ2ksICdfJykpO1xuICAgIGlmIChmaWxlbmFtZVswXSA9PT0gJy8nKSBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cigxKTtcbiAgICByZXR1cm4gZmlsZW5hbWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cml0ZUZpbGUoc3RyZWFtOiBSZWFkYWJsZSwgcGF0aDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICB2YXIgd3MgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShwYXRoKTtcbiAgICAgICAgd3Mub24oJ2ZpbmlzaCcsIHJlc29sdmUpXG4gICAgICAgIC5vbignZXJyb3InLCByZWplY3QpO1xuXG4gICAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzdHJlYW0ucGlwZSh3cyk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVUZW1wKHN0cmVhbTogUmVhZGFibGUsIHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgbGV0IHJuZCA9IGF3YWl0IHJhbmRvbU5hbWUocGF0aCk7XG4gICAgbGV0IHRtcEZpbGUgPSBQYXRoLmpvaW4ob3MudG1wZGlyKCksIHJuZCk7XG4gICAgYXdhaXQgd3JpdGVGaWxlKHN0cmVhbSwgdG1wRmlsZSk7XG4gICAgcmV0dXJuIHRtcEZpbGU7XG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
